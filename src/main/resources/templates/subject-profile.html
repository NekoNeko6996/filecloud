<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(${subject.mainName} + ' - Profile', 'subjects', ~{::section}, ~{::script})}">
    <body>

        <section class="flex-1 flex flex-col relative overflow-hidden bg-background-dark">

            <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <div class="flex items-center gap-2 text-sm">
                    <a th:href="@{/subjects}" class="text-[#a79cba] hover:text-white transition-colors">Subjects</a>
                    <span class="material-symbols-outlined text-[#a79cba] text-[16px]">chevron_right</span>
                    <span class="font-bold text-white bg-[#2e2839] px-2 py-1 rounded" th:text="${subject.mainName}">Name</span>
                </div>

                <div class="flex items-center gap-4 flex-1 justify-center max-w-lg mx-4">
                    <div class="relative w-full group">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#a79cba]">search</span>
                        <input id="fileSearchInput" 
                               class="w-full bg-[#1e1926] border border-white/5 rounded-full pl-10 pr-10 py-2 text-sm text-white placeholder-[#a79cba] focus:outline-none focus:ring-2 focus:ring-primary/50" 
                               placeholder="Search files..." type="text"/>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                <div class="flex flex-col gap-8">

                    <div class="flex flex-col md:flex-row gap-8 items-start">
                        <div class="relative shrink-0">
                            <div class="w-32 h-32 md:w-40 md:h-40 rounded-full p-1 bg-gradient-to-tr from-primary to-purple-400">
                                <img th:if="${subject.avatarUrl != null and subject.avatarUrl != ''}" th:src="${subject.avatarUrl}" class="w-full h-full rounded-full border-4 border-[#171022] object-cover">
                                <div th:unless="${subject.avatarUrl != null and subject.avatarUrl != ''}" class="w-full h-full rounded-full border-4 border-[#171022] bg-gray-700 flex items-center justify-center text-4xl font-bold text-white">
                                    <span th:text="${#strings.substring(subject.mainName,0,1)}">A</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col flex-1 gap-4 w-full">
                            <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
                                <div>
                                    <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-white mb-1" th:text="${subject.mainName}">Name</h1>
                                    <p class="text-gray-400 text-sm font-medium">
                                        aka <span class="text-primary" th:text="${subject.aliasName1}">Alias 1</span>
                                        <span th:if="${subject.aliasName2}">, <span th:text="${subject.aliasName2}">Alias 2</span></span>
                                    </p>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button onclick="openUploadModal()" 
                                            class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors w-fit shadow-lg shadow-primary/20">
                                        <span class="material-symbols-outlined text-[20px]">cloud_upload</span> Upload Media
                                    </button>
                                    <button onclick="document.getElementById('editProfileModal').showModal()" 
                                            class="flex items-center gap-2 bg-[#2e2839] hover:bg-white/10 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors w-fit border border-white/5">
                                        <span class="material-symbols-outlined text-[18px]">edit</span> Edit Profile
                                    </button>
                                </div>
                            </div>

                            <p class="text-gray-300 max-w-2xl leading-relaxed text-base" th:text="${subject.description ?: 'No description available.'}"></p>

                            <div class="flex items-center gap-3 mt-3">
                                <a th:each="link : ${subject.socialLinks}" 
                                   th:href="${(link.fullUrlOverride != null && link.fullUrlOverride != '') ? link.fullUrlOverride : link.platform.baseUrl + link.profilePath}" 
                                   target="_blank"
                                   class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-[#2e2839] border border-white/5 hover:border-primary/50 hover:bg-primary/10 transition-all group">
                                    <img th:if="${link.platform.iconUrl}" th:src="${link.platform.iconUrl}" class="w-4 h-4 rounded-full object-contain">
                                    <span th:unless="${link.platform.iconUrl}" class="material-symbols-outlined text-[18px] text-gray-400">public</span>
                                    <span class="text-xs font-medium text-gray-300 group-hover:text-primary" th:text="${link.platform.name}">Platform</span>
                                </a>

                                <button onclick="openSocialModal()" class="h-8 rounded p-2 flex items-center justify-center text-gray-500 hover:text-white hover:bg-white/10 transition-colors" title="Manage Social Links">
                                    <span class="material-symbols-outlined text-[18px]">edit</span> Socal Link
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-[#2e2839]/40 border border-white/5 p-5 rounded-xl flex flex-col gap-1 hover:border-primary/30 transition-colors">
                            <div class="flex items-center gap-2 text-gray-400 text-sm font-medium">
                                <span class="material-symbols-outlined text-[20px]">folder_open</span> Total Files
                            </div>
                            <p class="text-2xl font-bold text-white" th:text="${totalFiles}">0</p>
                        </div>
                        <div class="bg-[#2e2839]/40 border border-white/5 p-5 rounded-xl flex flex-col gap-1 hover:border-primary/30 transition-colors">
                            <div class="flex items-center gap-2 text-gray-400 text-sm font-medium">
                                <span class="material-symbols-outlined text-[20px]">hard_drive</span> Total Size
                            </div>
                            <p class="text-2xl font-bold text-white text-primary" th:text="${totalSize}">0 MB</p>
                        </div>
                        <div class="bg-[#2e2839]/40 border border-white/5 p-5 rounded-xl flex flex-col gap-1 hover:border-primary/30 transition-colors">
                            <div class="flex items-center gap-2 text-gray-400 text-sm font-medium">
                                <span class="material-symbols-outlined text-[20px]">schedule</span> Last Updated
                            </div>
                            <p class="text-2xl font-bold text-white" th:text="${#temporals.format(subject.updatedAt, 'dd/MM/yyyy')}">Date</p>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3" th:if="${not #lists.isEmpty(subjectTags)}">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                <span class="material-symbols-outlined text-[18px]">filter_list</span> Filter by Tags
                            </h4>
                            <button onclick="resetTagFilter()" id="btnResetTags" class="text-xs text-primary hover:text-white hidden transition-colors">Reset All</button>
                        </div>

                        <div class="flex flex-wrap gap-2" id="tagFilterContainer">
                            <button th:each="tag : ${subjectTags}"
                                    th:onclick="'toggleTagFilter(' + ${tag.id} + ', this)'"
                                    th:data-id="${tag.id}"
                                    class="tag-filter-btn px-3 py-1.5 rounded-lg border border-white/10 bg-[#2e2839] text-xs text-gray-300 font-medium hover:border-primary/50 hover:text-white transition-all select-none flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" th:style="'background-color:' + (${tag.colorHex} ?: '#833cf6')"></span>
                                <span th:text="${tag.name}">Tag Name</span>
                            </button>
                        </div>
                    </div>

                    <div class="columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4 pb-20" id="fileGrid">
                        <a th:each="file : ${files}" 
                           th:id="'file-card-' + ${file.id}"
                           th:data-id="${file.id}"
                           th:data-is-video="${file.isVideo()}"
                           onclick="handleFileClick(event, this.getAttribute('data-id'), this.getAttribute('data-is-video') === 'true')"
                           th:data-tag-ids="${fileTagMap.get(file.id)}"
                           th:href="${file.isVideo()} ? @{/video/{id}(id=${file.id})} : '#'"
                           oncontextmenu="showMediaContextMenu(event, this)"
                           target="_blank"
                           class="file-item break-inside-avoid group relative rounded-xl overflow-hidden bg-[#2e2839] cursor-pointer border border-white/5 block hover:border-primary/50 transition-colors select-none">

                            <div class="selection-checkbox absolute top-3 left-3 z-30 hidden group-hover:block has-[:checked]:block">
                                <input type="checkbox" value="${file.id}" 
                                       class="w-5 h-5 rounded border-gray-500 text-primary focus:ring-0 cursor-pointer hidden"
                                       onclick="event.stopPropagation()"> </div>

                            <img loading="lazy"
                                 th:src="@{/api/file/thumbnail/{id}(id=${file.id})}" 
                                 class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-500 min-h-[150px] bg-black/50"
                                 onerror="this.src='https://placehold.co/400x300/1e1e1e/FFF?text=No+Thumb'">

                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex flex-col justify-end p-4 pointer-events-none">
                                <p class="file-name text-white font-medium text-sm truncate" th:text="${file.name}">Name</p>
                                <p class="text-gray-400 text-xs" th:text="${file.readableSize}">Size</p>
                            </div>

                            <div th:if="${file.isVideo()}">
                                <div class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors flex items-center justify-center pointer-events-none">
                                    <div class="size-12 rounded-full bg-white/20 backdrop-blur border border-white/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all scale-75 group-hover:scale-100">
                                        <span class="material-symbols-outlined text-white">play_arrow</span>
                                    </div>
                                </div>
                                <div th:if="${file.durationFormatted != null}" 
                                     class="absolute bottom-2 right-2 bg-black/70 backdrop-blur-sm px-1.5 py-0.5 rounded text-[10px] font-bold text-white font-mono tracking-wide shadow-sm pointer-events-none">
                                    <span th:text="${file.durationFormatted}">04:20</span>
                                </div>
                            </div>

                            <div class="absolute top-2 right-2 bg-black/50 backdrop-blur rounded px-1.5 py-0.5 text-[10px] font-bold text-white uppercase pointer-events-none"
                                 th:if="${file.name.contains('.')}"
                                 th:text="${file.name.substring(file.name.lastIndexOf('.') + 1)}">EXT</div>
                        </a>
                    </div>

                    <div th:if="${files.isEmpty()}" class="flex flex-col items-center justify-center py-20 text-gray-500">
                        <span class="material-symbols-outlined text-6xl mb-4">perm_media</span>
                        <p>No media files found for this subject.</p>
                    </div>

                </div>
            </div>

            <dialog id="editProfileModal" class="bg-[#1e1e1e] text-white p-6 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-lg">
                <form th:action="@{/subjects/update}" method="post" enctype="multipart/form-data" class="flex flex-col gap-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-xl">Edit Profile</h3>
                        <button type="button" onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <input type="hidden" name="id" th:value="${subject.id}">

                    <div>
                        <label class="text-xs text-gray-400 mb-2 block uppercase font-bold tracking-wide">Avatar Image</label>

                        <div class="flex gap-4 items-start">
                            <div class="shrink-0 w-20 h-20 rounded-full border-2 border-white/20 overflow-hidden bg-black/50">
                                <img id="avatarPreview" th:src="${subject.avatarUrl}" 
                                     class="w-full h-full object-cover"
                                     onerror="this.src='https://ui-avatars.com/api/?name=User&background=random'">
                            </div>

                            <div class="flex-1">
                                <div class="flex gap-4 mb-2 text-sm border-b border-white/10 pb-1">
                                    <label class="cursor-pointer font-bold text-primary hover:text-primary-light">
                                        <input type="radio" name="avatarType" value="url" checked onchange="toggleAvatarInput('url')" class="hidden peer">
                                        <span class="peer-checked:underline">Paste Link</span>
                                    </label>
                                    <label class="cursor-pointer font-bold text-gray-400 hover:text-white">
                                        <input type="radio" name="avatarType" value="file" onchange="toggleAvatarInput('file')" class="hidden peer">
                                        <span class="peer-checked:text-primary peer-checked:underline">Upload File</span>
                                    </label>
                                </div>

                                <div id="inputUrlGroup">
                                    <input type="text" name="avatarUrl" id="avatarUrlInput" th:value="${subject.avatarUrl}" 
                                           placeholder="https://example.com/image.jpg"
                                           oninput="updatePreviewFromUrl(this.value)"
                                           class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-primary">
                                </div>

                                <div id="inputFileGroup" class="hidden">
                                    <input type="file" name="avatarFile" id="avatarFileInput" accept="image/*"
                                           onchange="updatePreviewFromFile(this)"
                                           class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary/20 file:text-primary hover:file:bg-primary/30">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Main Name</label>
                        <input type="text" name="mainName" th:value="${subject.mainName}" required 
                               class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Alias 1</label>
                            <input type="text" name="aliasName1" th:value="${subject.aliasName1}" 
                                   class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Alias 2</label>
                            <input type="text" name="aliasName2" th:value="${subject.aliasName2}" 
                                   class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Description</label>
                        <textarea name="description" rows="3" th:text="${subject.description}"
                                  class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary"></textarea>
                    </div>

                    <div class="flex gap-3 justify-end mt-4 pt-4 border-t border-white/5">
                        <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white font-medium">Cancel</button>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/20">Save Changes</button>
                    </div>
                </form>
            </dialog>


            <dialog id="uploadModal" class="bg-[#1e1e1e] text-white p-0 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-6xl h-[85vh]">
                <div class="flex flex-col h-full">
                    <div class="px-6 py-4 border-b border-white/10 flex justify-between items-center bg-[#2e2839]">
                        <h3 class="font-bold text-xl flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">cloud_upload</span> Upload Manager
                        </h3>
                        <button onclick="document.getElementById('uploadModal').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div class="flex flex-1 overflow-hidden">

                        <div class="w-1/3 border-r border-white/10 flex flex-col bg-[#171022]">
                            <div class="p-4 border-b border-white/5">
                                <h4 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-1">Destination Folders</h4>
                                <p class="text-xs text-gray-500">Select a folder to check info or assign files.</p>
                            </div>

                            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                                <div th:each="map, iter : ${mappings}" 
                                     th:onclick="'selectTargetFolder(' + ${map.id} + ', ' + ${map.volume.id} + ', this)'"
                                     th:data-id="${map.id}"
                                     th:classappend="${iter.index == 0} ? 'bg-primary/20 border-primary/50' : 'border-white/5 hover:bg-white/5'"
                                     class="folder-card cursor-pointer p-3 rounded-lg border transition-all relative group">

                                    <div class="flex justify-between items-start">
                                        <div class="flex items-center gap-3 overflow-hidden">
                                            <span class="material-symbols-outlined text-yellow-500 text-2xl">folder</span>
                                            <div class="min-w-0">
                                                <div class="text-sm font-bold text-white truncate" th:text="${map.relativePath}">Path</div>
                                                <div class="text-xs text-gray-400 flex items-center gap-1">
                                                    <span class="material-symbols-outlined text-[10px]">hard_drive</span>
                                                    <span th:text="${map.volume.label}">Volume</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div th:id="'vol-info-' + ${map.id}" class="mt-3 text-xs bg-black/30 p-2 rounded hidden">
                                        <div class="flex justify-between mb-1">
                                            <span class="text-gray-400">Storage</span>
                                            <span class="text-white font-bold val-free">--</span>
                                        </div>
                                        <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                                            <div class="bg-green-500 h-full w-0 transition-all duration-500 val-bar"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 border-t border-white/10 bg-[#1e1926]">
                                <button onclick="checkCurrentCapacity()" class="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 border border-white/10 text-white py-2 rounded-lg text-sm font-medium transition-colors mb-2">
                                    <span class="material-symbols-outlined text-[16px]">sync</span> Check Disk Space
                                </button>
                                <button onclick="assignSelectedToCurrent()" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary-dark text-white py-2 rounded-lg text-sm font-bold shadow-lg">
                                    <span class="material-symbols-outlined text-[18px]">drive_file_move</span> Assign Checkbox to This
                                </button>
                            </div>
                        </div>

                        <div class="w-2/3 flex flex-col bg-[#1e1e1e]">
                            <div id="dropZone" class="m-4 border-2 border-dashed border-white/20 rounded-xl bg-white/5 flex flex-col items-center justify-center py-8 transition-colors hover:border-primary/50 hover:bg-primary/5 cursor-pointer relative">
                                <input type="file" id="fileInput" multiple class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleFiles(this.files)">
                                <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">cloud_upload</span>
                                <p class="text-gray-300 font-medium">Drag & Drop files here or <span class="text-primary">Browse</span></p>
                                <p class="text-xs text-gray-500 mt-1">Supports Video & Images</p>
                            </div>

                            <div class="px-6 pb-2 flex justify-between items-center text-xs font-bold text-gray-400 uppercase tracking-wide border-b border-white/5">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" onchange="toggleAllUpload(this)" class="rounded bg-gray-700 border-gray-600 text-primary focus:ring-0">
                                    <span>File Name</span>
                                </div>
                                <div class="flex gap-12 pr-12">
                                    <span>Destination</span>
                                    <span>Size</span>
                                </div>
                            </div>

                            <div class="flex-1 overflow-y-auto px-4 py-2 space-y-2" id="uploadFileList">
                                <div id="emptyState" class="text-center py-10 text-gray-500">
                                    No files selected.
                                </div>
                            </div>

                            <div class="p-4 border-t border-white/10 bg-[#2e2839] flex justify-between items-center">
                                <div class="text-sm text-gray-400">
                                    Total: <span class="text-white font-bold" id="totalFilesCount">0</span> files
                                    (<span id="totalUploadSize">0 MB</span>)
                                </div>
                                <button onclick="startUpload()" id="btnStartUpload" disabled class="bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-white px-8 py-2.5 rounded-lg font-bold shadow-lg flex items-center gap-2">
                                    <span class="material-symbols-outlined">upload</span> Start Upload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </dialog>

            <dialog id="socialModal" class="bg-[#1e1e1e] text-white p-0 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-2xl">
                <div class="flex h-[500px]">

                    <div class="w-1/2 border-r border-white/10 flex flex-col bg-[#171022]">
                        <div class="p-4 border-b border-white/10 flex justify-between items-center">
                            <h3 class="font-bold text-sm text-gray-300">Current Links</h3>
                            <button onclick="resetSocialForm()" class="text-xs bg-primary/20 text-primary px-2 py-1 rounded hover:bg-primary hover:text-white transition-colors">
                                + Add New
                            </button>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2" id="socialListContainer">
                            <p class="text-center text-gray-500 text-xs mt-10">Loading...</p>
                        </div>
                    </div>

                    <div class="w-1/2 flex flex-col p-6 bg-[#1e1e1e]">
                        <h3 class="font-bold text-lg mb-4" id="socialFormTitle">Add New Link</h3>

                        <form id="socialForm" onsubmit="saveSocialLink(event)" class="flex flex-col gap-4 flex-1">
                            <input type="hidden" name="linkId" id="inputLinkId">
                            <input type="hidden" name="subjectId" th:value="${subject.id}">

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Platform</label>
                                <select name="platformId" id="selectPlatform" required 
                                        class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-primary">
                                </select>
                            </div>

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Profile Path / Username</label>
                                <input type="text" name="profilePath" id="inputProfilePath" required placeholder="e.g. username123"
                                       class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-primary">
                                <p class="text-[10px] text-gray-500 mt-1">Appended to Base URL</p>
                            </div>

                            <div>
                                <label class="text-xs text-gray-400 mb-1 block">Full URL Override (Optional)</label>
                                <input type="text" name="fullUrl" id="inputFullUrl" placeholder="https://..."
                                       class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-primary font-mono">
                                <p class="text-[10px] text-gray-500 mt-1">Use specific URL instead of auto-generated one</p>
                            </div>

                            <div class="mt-auto flex justify-end gap-2 pt-4 border-t border-white/5">
                                <button type="button" onclick="document.getElementById('socialModal').close()" class="px-3 py-2 text-sm text-gray-400 hover:text-white">Close</button>
                                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded text-sm font-bold shadow-lg">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            </dialog>

            <div id="mediaContextMenu" class="hidden fixed z-50 w-48 bg-[#1e1e1e] border border-gray-700 rounded-lg shadow-2xl overflow-hidden p-2">
                <button onclick="viewMediaDetails(event)" class="w-full text-left px-4 py-2.5 text-sm text-gray-300 rounded hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">info</span> Information
                </button>
                <button onclick="openManageTagsModal()" class="w-full text-left px-4 py-2.5 text-sm text-gray-300 rounded hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">label</span> Manage Tags
                </button>
                <button onclick="toggleSelectionMode()" class="w-full text-left px-4 py-2.5 text-sm text-gray-300 rounded hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">checklist</span> Select Multiple
                </button>
                <button onclick="downloadSingleMedia()" class="w-full text-left px-4 py-2.5 text-sm text-gray-300 rounded hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">download</span> Download
                </button>
                <button onclick="openRenameModal()" class="w-full text-left px-4 py-2.5 text-sm text-gray-300 rounded hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">edit_document</span> Rename
                </button>
                <div class="h-px bg-white/10 my-1 mx-2"></div>
                <button onclick="confirmDeleteMedia()" class="w-full text-left px-4 py-2.5 text-sm text-red-400 rounded hover:bg-red-500/10 hover:text-red-300 flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">delete</span> Delete
                </button>
            </div>

            <div id="selectionToolbar" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-[#1e1e1e] border border-white/10 rounded-full shadow-2xl px-6 py-3 flex items-center gap-6 animate-bounce-up">
                <span class="text-white font-bold text-sm"><span id="selectedCount" class="text-primary">0</span> Selected</span>
                <div class="h-4 w-px bg-white/20"></div>
                <button onclick="downloadBatchMedia()" class="text-green-400 hover:text-green-300 flex items-center gap-1 text-sm font-bold disabled:opacity-50" id="btnBatchDownload">
                    <span class="material-symbols-outlined text-[18px]">download</span> Download
                </button>
                <div class="h-4 w-px bg-white/20"></div>
                <button onclick="confirmDeleteMedia()" class="text-red-400 hover:text-red-300 flex items-center gap-1 text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed" id="btnBatchDelete">
                    <span class="material-symbols-outlined text-[18px]">delete</span> Delete
                </button>
                <button onclick="exitSelectionMode()" class="text-gray-400 hover:text-white flex items-center gap-1 text-sm font-medium">
                    <span class="material-symbols-outlined text-[18px]">close</span> Cancel
                </button>
            </div>

            <dialog id="deleteMediaModal" class="bg-[#1e1e1e] text-white p-6 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-sm">
                <div class="flex flex-col gap-4">
                    <div class="flex items-center gap-3 text-red-500">
                        <span class="material-symbols-outlined text-3xl">delete_forever</span>
                        <h3 class="text-lg font-bold text-white">Delete Media?</h3>
                    </div>

                    <p class="text-gray-300 text-sm">
                        You are about to remove <strong id="delMediaCount" class="text-white">1 item</strong> from the library.
                    </p>

                    <label class="flex items-start gap-3 cursor-pointer p-3 rounded-lg border border-white/10 hover:bg-white/5 transition-colors has-[:checked]:border-red-500/50 has-[:checked]:bg-red-500/10">
                        <input type="checkbox" id="checkDelMediaPhysical" class="mt-1 rounded bg-gray-700 border-gray-600 text-red-600 focus:ring-red-600">
                        <div>
                            <span class="font-bold text-white block text-sm">Delete from Disk</span>
                            <span class="text-xs text-gray-500 block mt-0.5">
                                Also permanently delete the physical file(s).
                            </span>
                        </div>
                    </label>

                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="document.getElementById('deleteMediaModal').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                        <button onclick="executeDeleteMedia()" id="btnExecDel" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">Delete</button>
                    </div>
                </div>
            </dialog>

            <dialog id="renameMediaModal" class="bg-[#1e1e1e] text-white p-6 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-sm">
                <div class="flex flex-col gap-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-lg">Rename File</h3>
                        <button onclick="document.getElementById('renameMediaModal').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block uppercase font-bold">New Filename</label>
                        <input type="text" id="inputNewFileName" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-white focus:outline-none focus:border-primary">
                        <p class="text-[10px] text-gray-500 mt-1 italic">File extension will be preserved automatically.</p>
                    </div>

                    <label class="flex items-start gap-3 cursor-pointer p-3 rounded-lg border border-white/10 hover:bg-white/5 transition-colors has-[:checked]:border-primary/50 has-[:checked]:bg-primary/10">
                        <input type="checkbox" id="checkRenamePhysical" class="mt-1 rounded bg-gray-700 border-gray-600 text-primary focus:ring-primary">
                        <div>
                            <span class="font-bold text-white block text-sm">Rename on Disk</span>
                            <span class="text-xs text-gray-500 block mt-0.5">
                                Change the actual filename on the hard drive.
                            </span>
                        </div>
                    </label>

                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="document.getElementById('renameMediaModal').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                        <button onclick="executeRenameMedia()" id="btnExecRename" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg">Save</button>
                    </div>
                </div>
            </dialog>

            <aside id="detailsPanel" class="glass-panel fixed right-0 top-0 h-screen w-80 flex flex-col border-l border-white/10 overflow-y-auto no-scrollbar z-50 bg-[#171022] shadow-2xl translate-x-full transition-transform duration-300 ease-in-out">
                <div class="p-6 flex flex-col gap-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-white font-bold text-base">File Details</h3>
                        <button onclick="closeDetails()" class="text-[#a79cba] hover:text-white transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div class="flex flex-col gap-3">
                        <div class="aspect-video w-full rounded-lg bg-gray-800 border border-white/10 relative group overflow-hidden flex items-center justify-center">
                            <img id="detailPreview" src="" class="w-full h-full object-contain hidden">
                            <span id="detailIcon" class="material-symbols-outlined text-5xl text-gray-500">description</span>
                        </div>
                        <div>
                            <h2 id="detailName" class="text-white font-bold text-lg leading-tight break-words">Filename</h2>
                            <p id="detailSize" class="text-[#a79cba] text-sm mt-1">Size</p>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <h4 class="text-white text-sm font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined text-[16px] text-pink-400">label</span> Tags
                        </h4>
                        <div id="detailTagList" class="flex flex-wrap gap-2">
                            <span class="text-gray-500 text-xs italic">Loading tags...</span>
                        </div>
                    </div>

                    <div class="h-px bg-white/10 w-full"></div>

                    <div class="flex flex-col gap-4">
                        <h4 class="text-white text-sm font-bold">Metadata</h4>
                        <div class="flex flex-col gap-3" id="metaContainer">
                            <p class="text-gray-500 text-xs italic">Loading info...</p>
                        </div>
                    </div>
                </div>
            </aside>

            <dialog id="manageTagsModal" class="bg-[#1e1e1e] text-white p-0 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-md">
                <div class="flex flex-col h-[500px]">
                    <div class="p-4 border-b border-white/10 flex justify-between items-center bg-[#2e2839]">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <span class="material-symbols-outlined text-pink-400">label</span> Manage Tags
                        </h3>
                        <button onclick="document.getElementById('manageTagsModal').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <div class="p-4 border-b border-white/10 bg-[#171022]">
                        <p class="text-xs text-gray-400 uppercase font-bold mb-2">Active Tags</p>
                        <div id="activeTagsList" class="flex flex-wrap gap-2 min-h-[40px]">
                            <span class="text-gray-500 text-sm italic">No tags assigned.</span>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col p-4">
                        <div class="relative group mb-4">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
                            <input type="text" id="tagSearchInput" onkeyup="handleTagSearch(this.value)" 
                                   placeholder="Search or create new tag..." 
                                   class="w-full bg-black/30 border border-white/10 rounded-lg pl-10 pr-4 py-3 text-sm text-white focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                        </div>

                        <div class="flex-1 overflow-y-auto space-y-1" id="tagSearchResults">
                            <p class="text-center text-gray-500 text-xs mt-4">Type to search tags.</p>
                        </div>

                        <div id="createTagOption" class="hidden mt-2 pt-2 border-t border-white/10">
                            <button onclick="createNewTag()" class="w-full flex items-center justify-between p-3 bg-primary/10 border border-primary/30 rounded-lg text-primary hover:bg-primary/20 transition-colors">
                                <span class="font-bold text-sm">Create new tag: "<span id="newTagName"></span>"</span>
                                <span class="material-symbols-outlined">add_circle</span>
                            </button>
                        </div>
                    </div>
                </div>
            </dialog>

            <div id="copyToast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-[#1e1e1e] border border-white/10 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 opacity-0 pointer-events-none transition-all duration-300 z-[100] transform translate-y-4">
                <span class="material-symbols-outlined text-green-500 text-sm">check_circle</span>
                <span class="text-sm font-bold">Copied to clipboard!</span>
            </div>
        </section>

        <script th:inline="javascript">
            // --- JS TÌM KIẾM FILE (CLIENT SIDE) ---
            document.getElementById('fileSearchInput').addEventListener('keyup', function (e) {
                const term = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.file-item');

                items.forEach(item => {
                    const name = item.querySelector('.file-name').innerText.toLowerCase();
                    if (name.includes(term)) {
                        item.style.display = ''; // Hiện lại (theo layout flex/grid)
                    } else {
                        item.style.display = 'none'; // Ẩn đi
                    }
                });
            });

            let activeTagIds = new Set(); // Lưu các ID tag đang chọn

            // 1. Sự kiện Tìm kiếm (Replace code cũ của search input)
            document.getElementById('fileSearchInput').addEventListener('keyup', function (e) {
                applyFilters();
            });

            // 2. Toggle chọn Tag
            function toggleTagFilter(tagId, btn) {
                if (activeTagIds.has(tagId)) {
                    activeTagIds.delete(tagId);
                    // Style Inactive
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('bg-[#2e2839]', 'text-gray-300', 'border-white/10');
                } else {
                    activeTagIds.add(tagId);
                    // Style Active
                    btn.classList.remove('bg-[#2e2839]', 'text-gray-300', 'border-white/10');
                    btn.classList.add('bg-primary', 'text-white', 'border-primary');
                }

                // Hiện/Ẩn nút Reset
                document.getElementById('btnResetTags').classList.toggle('hidden', activeTagIds.size === 0);

                applyFilters();
            }

            // 3. Reset Filter
            function resetTagFilter() {
                activeTagIds.clear();
                document.querySelectorAll('.tag-filter-btn').forEach(btn => {
                    btn.classList.remove('bg-primary', 'text-white', 'border-primary');
                    btn.classList.add('bg-[#2e2839]', 'text-gray-300', 'border-white/10');
                });
                document.getElementById('btnResetTags').classList.add('hidden');
                applyFilters();
            }

            // 4. Logic Lọc Chính (Core)
            function applyFilters() {
                const searchVal = document.getElementById('fileSearchInput').value.toLowerCase();
                const items = document.querySelectorAll('.file-item');
                let visibleCount = 0;

                items.forEach(item => {
                    // Lọc theo Tên
                    const name = item.querySelector('.file-name').innerText.toLowerCase();
                    const matchesName = name.includes(searchVal);

                    // Lọc theo Tag (Logic AND: File phải chứa TẤT CẢ tag đang chọn)
                    // Nếu muốn Logic OR (Chứa 1 trong các tag) -> dùng activeTagIds.some(...)
                    let matchesTags = true;
                    if (activeTagIds.size > 0) {
                        const fileTagsAttr = item.getAttribute('data-tag-ids'); // Chuỗi "1 5 9"
                        if (!fileTagsAttr) {
                            matchesTags = false; // Không có tag nào thì auto fail nếu đang lọc
                        } else {
                            const fileTagArray = fileTagsAttr.split(' ').map(Number);
                            // Kiểm tra xem file có chứa mọi tag đang active không
                            for (let tagId of activeTagIds) {
                                if (!fileTagArray.includes(tagId)) {
                                    matchesTags = false;
                                    break;
                                }
                            }
                        }
                    }

                    // Kết quả cuối cùng
                    if (matchesName && matchesTags) {
                        item.style.display = ''; // Hiện
                        visibleCount++;
                    } else {
                        item.style.display = 'none'; // Ẩn
                    }
                });

                // (Optional) Hiển thị thông báo nếu không tìm thấy
                // console.log("Visible Items:", visibleCount);
            }


            // --- LOGIC AVATAR PREVIEW ---
            function toggleAvatarInput(type) {
                const urlGroup = document.getElementById('inputUrlGroup');
                const fileGroup = document.getElementById('inputFileGroup');
                const urlInput = document.getElementById('avatarUrlInput');
                const fileInput = document.getElementById('avatarFileInput');

                if (type === 'url') {
                    urlGroup.classList.remove('hidden');
                    fileGroup.classList.add('hidden');
                    fileInput.value = ''; // Reset file input
                    updatePreviewFromUrl(urlInput.value); // Khôi phục preview từ URL
                } else {
                    urlGroup.classList.add('hidden');
                    fileGroup.classList.remove('hidden');
                    // Không reset URL input để user có thể quay lại nếu muốn
                }
            }

            function updatePreviewFromUrl(url) {
                const preview = document.getElementById('avatarPreview');
                if (url && url.trim() !== '') {
                    preview.src = url;
                } else {
                    preview.src = 'https://ui-avatars.com/api/?name=User&background=random'; // Fallback
                }
            }

            function updatePreviewFromFile(input) {
                const preview = document.getElementById('avatarPreview');
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        preview.src = e.target.result;
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }
        </script>
        <script th:inline="javascript">
            // --- DATA ---
            let uploadQueue = []; // Mảng chứa { file: FileObj, mappingId: int, mappingPath: string }
            let activeMappingId = /*[[${mappings.isEmpty() ? null : mappings[0].id}]]*/ null;
            let activeVolumeId = /*[[${mappings.isEmpty() ? null : mappings[0].volume.id}]]*/ null;
            const mappingsData = /*[[${mappings}]]*/ []; // Dữ liệu mapping từ server

            // --- UI FUNCTIONS ---
            function openUploadModal() {
                if (!activeMappingId && mappingsData.length > 0) {
                    // Select first by default
                    const first = document.querySelector('.folder-card');
                    if (first)
                        selectTargetFolder(mappingsData[0].id, mappingsData[0].volume.id, first);
                }
                document.getElementById('uploadModal').showModal();
            }

            function selectTargetFolder(mapId, volId, el) {
                activeMappingId = mapId;
                activeVolumeId = volId;

                // Update UI style
                document.querySelectorAll('.folder-card').forEach(c => {
                    c.classList.remove('bg-primary/20', 'border-primary/50');
                    c.classList.add('border-white/5', 'hover:bg-white/5');
                });
                el.classList.remove('border-white/5', 'hover:bg-white/5');
                el.classList.add('bg-primary/20', 'border-primary/50');
            }

            function checkCurrentCapacity() {
                if (!activeVolumeId)
                    return;
                const btn = event.currentTarget;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[16px]">sync</span> Checking...';

                fetch(`/subjects/check-capacity/${activeVolumeId}`)
                        .then(res => res.json())
                        .then(data => {
                            const infoBox = document.getElementById(`vol-info-${activeMappingId}`);
                            if (infoBox) {
                                infoBox.classList.remove('hidden');
                                infoBox.querySelector('.val-free').innerText = `${data.free} / ${data.total} Free`;
                                infoBox.querySelector('.val-bar').style.width = `${100 - data.percent}%`; // % used

                                // Color logic
                                const bar = infoBox.querySelector('.val-bar');
                                if (data.percent > 90)
                                    bar.className = 'bg-red-500 h-full transition-all duration-500 val-bar';
                                else if (data.percent > 70)
                                    bar.className = 'bg-yellow-500 h-full transition-all duration-500 val-bar';
                                else
                                    bar.className = 'bg-green-500 h-full transition-all duration-500 val-bar';
                            }
                        })
                        .finally(() => btn.innerHTML = originalHtml);
            }

            // --- FILE HANDLING ---
            function handleFiles(files) {
                if (!activeMappingId)
                    return alert("Please create/import a folder mapping first!");

                // Mặc định gán vào activeMappingId hoặc mapping đầu tiên
                const defaultMap = mappingsData.find(m => m.id === activeMappingId) || mappingsData[0];

                Array.from(files).forEach(file => {
                    uploadQueue.push({
                        file: file,
                        mappingId: defaultMap.id,
                        mappingPath: defaultMap.relativePath,
                        status: 'pending', // pending, uploading, done, error
                        selected: false
                    });
                });
                renderFileList();
            }

            function renderFileList() {
                const list = document.getElementById('uploadFileList');
                const btn = document.getElementById('btnStartUpload');

                // TRƯỜNG HỢP DANH SÁCH RỖNG
                if (uploadQueue.length === 0) {
                    // Tự tạo lại nội dung Empty State bằng HTML string
                    list.innerHTML = `
                        <div id="emptyState" class="text-center py-10 text-gray-500">
                            No files selected.
                        </div>`;

                    btn.disabled = true;
                    updateStats();
                    return;
                }

                // TRƯỜNG HỢP CÓ FILE
                btn.disabled = false;

                // Render danh sách file
                list.innerHTML = uploadQueue.map((item, index) => `
                    <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:border-primary/30 group">
                        <div class="flex items-center gap-3 overflow-hidden flex-1">
                            <input type="checkbox" onchange="toggleFileSelection(${index}, this)" class="file-check rounded bg-gray-700 border-gray-600 text-primary focus:ring-0" ${item.selected ? 'checked' : ''}>
                            <div class="w-8 h-8 rounded bg-black/50 flex items-center justify-center text-xs font-bold text-gray-400">
                                ${item.file.name.split('.').pop().toUpperCase()}
                            </div>
                            <div class="min-w-0">
                                <p class="text-sm text-white font-medium truncate">${item.file.name}</p>
                                <p class="text-xs ${item.status === 'error' ? 'text-red-400' : (item.status === 'done' ? 'text-green-400' : 'text-gray-500')}">
                                    ${item.status === 'pending' ? 'Ready' : item.status}
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-8 items-center pl-4">
                            <span class="text-xs bg-primary/20 text-primary px-2 py-1 rounded border border-primary/20 font-mono truncate max-w-[150px]" title="${item.mappingPath}">
                                ${item.mappingPath}
                            </span>
                            <span class="text-xs text-gray-400 w-16 text-right">${(item.file.size / 1024 / 1024).toFixed(2)} MB</span>
                            <button onclick="removeFile(${index})" class="text-gray-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>
                `).join('');

                updateStats();
            }

            function toggleFileSelection(index, checkbox) {
                uploadQueue[index].selected = checkbox.checked;
            }

            function toggleAllUpload(source) {
                uploadQueue.forEach(item => item.selected = source.checked);
                renderFileList();
            }

            function removeFile(index) {
                uploadQueue.splice(index, 1);
                renderFileList();
            }

            function updateStats() {
                document.getElementById('totalFilesCount').innerText = uploadQueue.length;
                const totalSize = uploadQueue.reduce((acc, item) => acc + item.file.size, 0);
                document.getElementById('totalUploadSize').innerText = (totalSize / 1024 / 1024).toFixed(2) + " MB";
            }

            // --- LOGIC GÁN FOLDER ĐÍCH (Yêu cầu của bạn) ---
            function assignSelectedToCurrent() {
                if (!activeMappingId)
                    return alert("Select a target folder on the left first.");

                const targetMap = mappingsData.find(m => m.id === activeMappingId);
                let count = 0;

                uploadQueue.forEach(item => {
                    if (item.selected && item.status === 'pending') {
                        item.mappingId = targetMap.id;
                        item.mappingPath = targetMap.relativePath;
                        item.selected = false; // Bỏ check sau khi gán
                        count++;
                    }
                });

                if (count > 0) {
                    renderFileList();
                    // Reset checkbox header
                    document.querySelector('input[onchange="toggleAllUpload(this)"]').checked = false;
                } else {
                    alert("No files selected (or files already uploaded). Check the boxes next to files first.");
                }
            }

            // --- UPLOAD EXECUTION ---
            async function startUpload() {
                const btn = document.getElementById('btnStartUpload');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Uploading...';

                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                for (let i = 0; i < uploadQueue.length; i++) {
                    const item = uploadQueue[i];
                    if (item.status !== 'pending')
                        continue;

                    item.status = 'Uploading...';
                    renderFileList(); // Update status text

                    const formData = new FormData();
                    formData.append("file", item.file);
                    formData.append("mappingId", item.mappingId);

                    try {
                        const res = await fetch('/subjects/upload-media', {
                            method: 'POST',
                            headers: {[csrfHeader]: csrfToken},
                            body: formData
                        });

                        if (res.ok) {
                            item.status = 'done';
                        } else {
                            const txt = await res.text();
                            item.status = 'error';
                            console.error(txt);
                        }
                    } catch (e) {
                        item.status = 'error';
                        console.error(e);
                    }
                    renderFileList(); // Refresh UI
                }

                btn.disabled = false;
                btn.innerHTML = '<span class="material-symbols-outlined">check</span> Done';
                setTimeout(() => {
                    btn.innerHTML = '<span class="material-symbols-outlined">upload</span> Start Upload';
                    // Reload page to show new files? Or just clear list?
                    if (confirm("Upload completed. Reload page to see new files?")) {
                        window.location.reload();
                    }
                }, 1000);
            }
        </script>
        <script th:inline="javascript">
            // --- SOCIAL LINKS LOGIC ---
            const subjectId = /*[[${subject.id}]]*/ 0;
            let allPlatforms = [];

            function openSocialModal() {
                document.getElementById('socialModal').showModal();
                loadPlatforms();
                loadSocialLinks();
                resetSocialForm();
            }

            // 1. Load Platforms cho Dropdown
            async function loadPlatforms() {
                if (allPlatforms.length > 0)
                    return; // Cache
                try {
                    const res = await fetch('/subjects/platforms');
                    allPlatforms = await res.json();
                    const select = document.getElementById('selectPlatform');
                    select.innerHTML = allPlatforms.map(p =>
                            `<option value="${p.id}">${p.name} (${p.baseUrl})</option>`
                    ).join('');
                } catch (e) {
                    console.error(e);
                }
            }

            // 2. Load danh sách Link hiện tại
            async function loadSocialLinks() {
                const list = document.getElementById('socialListContainer');
                list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Loading...</p>';

                try {
                    const res = await fetch(`/subjects/${subjectId}/socials`);
                    const links = await res.json();

                    if (links.length === 0) {
                        list.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">No links added yet.</p>';
                        return;
                    }

                    list.innerHTML = links.map(link => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded border border-white/5 hover:bg-white/10 group">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <img src="${link.iconUrl || 'https://ui-avatars.com/api/?name=' + link.platformName}" class="w-6 h-6 rounded-full object-contain bg-black/20">
                                <div class="min-w-0">
                                    <p class="text-xs font-bold text-white truncate">${link.platformName}</p>
                                    <a href="${link.finalUrl}" target="_blank" class="text-[10px] text-gray-400 truncate font-mono hover:text-primary hover:underline">
                                        ${link.profilePath}
                                    </a>
                                </div>
                            </div>
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick='editSocialLink(${JSON.stringify(link)})' class="p-1 text-gray-400 hover:text-blue-400" title="Edit">
                                    <span class="material-symbols-outlined text-[16px]">edit</span>
                                </button>
                                <button onclick="deleteSocialLink(${link.id})" class="p-1 text-gray-400 hover:text-red-400" title="Delete">
                                    <span class="material-symbols-outlined text-[16px]">delete</span>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    console.error(e);
                    list.innerHTML = '<p class="text-red-400 text-xs text-center">Error loading data</p>';
                }
            }

            // 3. Reset Form (Mode Add)
            function resetSocialForm() {
                document.getElementById('socialForm').reset();
                document.getElementById('inputLinkId').value = '';
                document.getElementById('socialFormTitle').innerText = 'Add New Link';
            }

            // 4. Edit Mode
            function editSocialLink(link) {
                document.getElementById('inputLinkId').value = link.id;
                document.getElementById('selectPlatform').value = link.platformId;
                document.getElementById('inputProfilePath').value = link.profilePath;
                document.getElementById('inputFullUrl').value = link.fullUrlOverride || '';
                document.getElementById('socialFormTitle').innerText = 'Edit Link: ' + link.platformName;
            }

            // 5. Save Action
            async function saveSocialLink(e) {
                e.preventDefault();
                const form = document.getElementById('socialForm');
                const formData = new FormData(form);
                const btn = form.querySelector('button[type="submit"]');
                const oldText = btn.innerText;

                btn.disabled = true;
                btn.innerText = 'Saving...';

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const res = await fetch('/subjects/socials/save', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken}, // Giả định dùng Spring Security
                        body: formData
                    });

                    if (res.ok) {
                        loadSocialLinks(); // Reload list
                        resetSocialForm(); // Reset form
                        // Optional: Reload page to update main view header
//                        window.location.reload();
                    } else {
                        alert("Save failed: " + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert("Connection error");
                } finally {
                    btn.disabled = false;
                    btn.innerText = oldText;
                }
            }

            // 6. Delete Action
            async function deleteSocialLink(id) {
                if (!confirm("Remove this link?"))
                    return;

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const formData = new FormData();
                    formData.append('linkId', id);

                    const res = await fetch('/subjects/socials/delete', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken},
                        body: formData
                    });

                    if (res.ok) {
                        loadSocialLinks();
                    } else {
                        alert("Delete failed");
                    }
                } catch (e) {
                    console.error(e);
                }
            }


            // --- MEDIA CONTEXT MENU & SELECTION ---
            const mediaMenu = document.getElementById('mediaContextMenu');
            let rightClickedFileId = null;
            let isSelectionMode = false;

            // 1. Show Context Menu
            function showMediaContextMenu(e, el) {
                e.preventDefault();
                e.stopPropagation(); // Ngăn sự kiện lan ra ngoài

                // Nếu đang ở Selection Mode -> Không hiện menu, chỉ check/uncheck
                if (isSelectionMode)
                    return;

                rightClickedFileId = el.getAttribute('data-id');

                let x = e.clientX;
                let y = e.clientY;

                // Điều chỉnh vị trí để không bị tràn
                if (window.innerWidth - x < 200)
                    x -= 200;
                if (window.innerHeight - y < 100)
                    y -= 100;

                mediaMenu.style.left = `${x}px`;
                mediaMenu.style.top = `${y}px`;
                mediaMenu.classList.remove('hidden');
            }

            // Ẩn menu khi click ra ngoài
            document.addEventListener('click', function (e) {
                // 1. Xử lý đóng Context Menu (Subject & Media)
                const subjectMenu = document.getElementById('subjectContextMenu');
                const mediaMenu = document.getElementById('mediaContextMenu');

                if (subjectMenu && !subjectMenu.contains(e.target)) {
                    subjectMenu.classList.add('hidden');
                }
                if (mediaMenu && !mediaMenu.contains(e.target)) {
                    mediaMenu.classList.add('hidden');
                }

                // 2. Xử lý đóng Details Panel (Logic Mới)
                const panel = document.getElementById('detailsPanel');
                // Nếu click KHÔNG nằm trong panel VÀ panel đang mở
                if (panel && !panel.contains(e.target) && !panel.classList.contains('translate-x-full')) {
                    closeDetails();
                }
            });
            document.addEventListener('scroll', () => mediaMenu.classList.add('hidden'));

            // 2. Toggle Selection Mode
            function toggleSelectionMode() {
                isSelectionMode = true;
                mediaMenu.classList.add('hidden');

                // Hiện checkbox trên tất cả các item
                document.querySelectorAll('.selection-checkbox').forEach(el => el.classList.remove('hidden'));

                // Hiện Toolbar
                document.getElementById('selectionToolbar').classList.remove('hidden');

                // Nếu bắt đầu từ 1 file cụ thể -> check luôn file đó
                if (rightClickedFileId) {
                    const card = document.getElementById('file-card-' + rightClickedFileId);
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    if (checkbox)
                        checkbox.checked = true;
                    updateSelectionCount();
                }
            }

            function exitSelectionMode() {
                isSelectionMode = false;
                rightClickedFileId = null;

                // Ẩn Toolbar
                document.getElementById('selectionToolbar').classList.add('hidden');

                // Reset checkbox
                document.querySelectorAll('.selection-checkbox').forEach(el => {
                    el.classList.add('hidden');
                    const cb = el.querySelector('input');
                    if (cb)
                        cb.checked = false;
                });

                // Remove active styling
                document.querySelectorAll('.file-item').forEach(el => el.classList.remove('ring-2', 'ring-primary'));
            }

            // 3. Handle File Click (Chặn chuyển trang khi đang chọn)
            function handleFileClick(e, fileId, isVideo) {
                if (isSelectionMode) {
                    e.preventDefault(); // Ngăn thẻ <a> chuyển trang

                    const card = document.getElementById('file-card-' + fileId);
                    const checkbox = card.querySelector('input[type="checkbox"]');

                    // Toggle check
                    checkbox.checked = !checkbox.checked;
                    updateSelectionCount();
                    return;
                }

                // Nếu không phải selection mode -> Chạy mặc định (chuyển trang)
            }

            // Helper: Cập nhật số lượng đang chọn
            function updateSelectionCount() {
                const count = document.querySelectorAll('.selection-checkbox input:checked').length;
                document.getElementById('selectedCount').innerText = count;
                document.getElementById('btnBatchDelete').disabled = count === 0;

                // Highlight border card được chọn
                document.querySelectorAll('.file-item').forEach(el => {
                    const cb = el.querySelector('input[type="checkbox"]');
                    if (cb && cb.checked)
                        el.classList.add('ring-2', 'ring-primary');
                    else
                        el.classList.remove('ring-2', 'ring-primary');
                });
            }

            // --- DELETE MEDIA LOGIC ---
            function confirmDeleteMedia() {
                mediaMenu.classList.add('hidden');

                let count = 0;
                if (isSelectionMode) {
                    count = document.querySelectorAll('.selection-checkbox input:checked').length;
                } else if (rightClickedFileId) {
                    count = 1;
                }

                if (count === 0)
                    return;

                document.getElementById('delMediaCount').innerText = count + (count === 1 ? ' item' : ' items');
                document.getElementById('checkDelMediaPhysical').checked = false; // Reset checkbox mặc định là false
                document.getElementById('deleteMediaModal').showModal();
            }

            async function executeDeleteMedia() {
                const btn = document.getElementById('btnExecDel');
                btn.disabled = true;
                btn.innerHTML = 'Deleting...';

                // Thu thập ID
                let idsToDelete = [];
                if (isSelectionMode) {
                    document.querySelectorAll('.selection-checkbox input:checked').forEach(cb => {
                        // Tìm data-id từ thẻ cha (thẻ a)
                        const parentA = cb.closest('a');
                        if (parentA)
                            idsToDelete.push(parentA.getAttribute('data-id'));
                    });
                } else if (rightClickedFileId) {
                    idsToDelete.push(rightClickedFileId);
                }

                const deletePhysical = document.getElementById('checkDelMediaPhysical').checked;

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

                    const res = await fetch('/subjects/media/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify({
                            fileIds: idsToDelete,
                            deletePhysical: deletePhysical
                        })
                    });

                    if (res.ok) {
                        // Xóa thành công -> Remove khỏi UI ngay lập tức
                        idsToDelete.forEach(id => {
                            const el = document.getElementById('file-card-' + id);
                            if (el)
                                el.remove();
                        });

                        // Update stats header (Số lượng file, dung lượng...)
                        // Cách đơn giản nhất: reload trang (hoặc trừ số liệu bằng JS)
                        // window.location.reload(); 

                        document.getElementById('deleteMediaModal').close();
                        exitSelectionMode(); // Thoát chế độ chọn

                        // Update lại số lượng hiển thị (Optional)
                        const totalEl = document.querySelector('.total-files-display');
                        // logic update số lượng...
                    } else {
                        alert("Delete failed: " + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error communicating with server");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'Delete';
                }
            }
        </script>
        <script th:inline="javascript">
            // --- DETAILS PANEL LOGIC ---
            const detailsPanel = document.getElementById('detailsPanel');

            function closeDetails() {
                detailsPanel.classList.remove('translate-x-0');
                detailsPanel.classList.add('translate-x-full');
            }

            // Helper format giây -> MM:SS
            function formatDuration(seconds) {
                if (!seconds)
                    return "";
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                return `${min}:${sec.toString().padStart(2, '0')}`;
            }

            // --- HÀM XỬ LÝ COPY CLIPBOARD ---
            function copyToClipboard(text) {
                if (!text)
                    return;

                // 1. Copy vào clipboard
                navigator.clipboard.writeText(text).then(() => {
                    // 2. Hiển thị Toast
                    const toast = document.getElementById('copyToast');

                    // Reset trạng thái để có thể trigger animation lại nếu click liên tục
                    toast.classList.remove('opacity-0', 'translate-y-4');
                    toast.classList.add('opacity-100', 'translate-y-0');

                    // 3. Ẩn sau 2 giây
                    if (window.copyTimeout)
                        clearTimeout(window.copyTimeout);

                    window.copyTimeout = setTimeout(() => {
                        toast.classList.remove('opacity-100', 'translate-y-0');
                        toast.classList.add('opacity-0', 'translate-y-4');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            }

            function viewMediaDetails(e) {
                if (e)
                    e.stopPropagation();

                // Ẩn menu chuột phải
                mediaMenu.classList.add('hidden');

                if (!rightClickedFileId)
                    return;

                // Slide panel ra
                detailsPanel.classList.remove('translate-x-full');
                detailsPanel.classList.add('translate-x-0');

                const tagContainer = document.getElementById('detailTagList');
                tagContainer.innerHTML = '<span class="text-gray-500 text-xs animate-pulse">Fetching tags...</span>';

                // Reset UI loading
                document.getElementById('detailName').innerText = "Loading...";
                document.getElementById('detailSize').innerText = "...";
                document.getElementById('metaContainer').innerHTML = '<p class="text-gray-500 text-xs animate-pulse">Fetching metadata...</p>';

                const img = document.getElementById('detailPreview');
                const icon = document.getElementById('detailIcon');

                // Hiển thị thumbnail (vì đây là media nên chắc chắn có thumb)
                img.src = `/api/file/thumbnail/${rightClickedFileId}`;
                img.classList.remove('hidden');
                icon.classList.add('hidden');

                // Gọi API lấy thông tin chi tiết
                fetch(`/api/file/metadata/${rightClickedFileId}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('detailName').innerText = data.name;
                            document.getElementById('detailSize').innerText = data.size;

                            const container = document.getElementById('metaContainer');
                            container.innerHTML = '';

                            // Hàm helper thêm dòng dữ liệu
                            const addRow = (label, value) => {
                                if (value == null || value === '')
                                    return;

                                // 1. Chuyển về String
                                // 2. Escape dấu gạch chéo (\ -> \\) để không bị mất trong JS string
                                // 3. Escape dấu nháy kép (" -> &quot;) để không phá vỡ HTML attribute
                                const safeValue = String(value)
                                        .replace(/\\/g, '\\\\')
                                        .replace(/"/g, '&quot;');

                                container.innerHTML += `
                                <div class="flex justify-between items-center text-sm py-2 border-b border-white/5 last:border-0 
                                            cursor-pointer hover:bg-white/10 active:bg-white/20 transition-colors group select-none"
                                     onclick="copyToClipboard('${safeValue}')"
                                     title="Click to copy">
                                    <span class="text-[#a79cba] font-medium group-hover:text-white transition-colors">${label}</span>
                                    <span class="text-white truncate max-w-[160px] group-hover:text-primary transition-colors">${value}</span>
                                </div>`;
                            };

                            addRow("Type", data.type);
                            addRow("Date", data.created ? new Date(data.created).toLocaleDateString() : "");
                            addRow("Relative", data.relative ? data.relative : "can not get relative path.");
                            addRow("File Hash", data.hash ? data.hash : "can not get file hash.");

                            // Hiển thị Metadata Media (Nếu có)
                            if (data.meta && data.meta !== "N/A") {
                                const m = data.meta;
                                if (m.width && m.height)
                                    addRow("Resolution", `${m.width} x ${m.height}`);
                                if (m.durationSeconds)
                                    addRow("Duration", formatDuration(m.durationSeconds));
                                if (m.videoCodec)
                                    addRow("Codec", m.videoCodec.toUpperCase());
                                if (m.frameRate)
                                    addRow("Frame Rate", Math.round(m.frameRate) + " fps");
                                if (m.takenAt)
                                    addRow("Taken At", new Date(m.takenAt).toLocaleDateString());
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            document.getElementById('metaContainer').innerHTML = '<p class="text-red-400 text-xs">Error loading info.</p>';
                        });


                fetch(`/subjects/media/tags?fileId=${rightClickedFileId}`)
                        .then(res => res.json())
                        .then(tags => {
                            if (tags.length === 0) {
                                tagContainer.innerHTML = '<span class="text-gray-500 text-xs italic">No tags assigned.</span>';
                                return;
                            }

                            tagContainer.innerHTML = tags.map(tag => `
                            <span class="inline-flex items-center px-2 py-1 rounded text-[10px] font-bold text-white border border-white/10 shadow-sm" 
                                  style="background-color: ${tag.colorHex || '#833cf6'}">
                                ${tag.name}
                            </span>
                        `).join('');
                        })
                        .catch(err => {
                            console.error(err);
                            tagContainer.innerHTML = '<span class="text-red-400 text-xs">Error loading tags.</span>';
                        });
            }
        </script>
        <script th:inline="javascript">
            // --- MANAGE TAGS LOGIC ---
            let currentTagSearchTerm = '';

            function openManageTagsModal() {
                mediaMenu.classList.add('hidden'); // Đóng menu chuột phải
                if (!rightClickedFileId)
                    return;

                document.getElementById('manageTagsModal').showModal();
                loadFileTags();

                // Reset search
                document.getElementById('tagSearchInput').value = '';
                document.getElementById('tagSearchResults').innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Type to search tags.</p>';
                document.getElementById('createTagOption').classList.add('hidden');
            }

            // 1. Load tags hiện có của file
            async function loadFileTags() {
                const container = document.getElementById('activeTagsList');
                container.innerHTML = '<span class="text-gray-500 text-xs animate-pulse">Loading...</span>';

                try {
                    const res = await fetch(`/subjects/media/tags?fileId=${rightClickedFileId}`);
                    const tags = await res.json();

                    if (tags.length === 0) {
                        container.innerHTML = '<span class="text-gray-500 text-sm italic">No tags assigned.</span>';
                        return;
                    }

                    container.innerHTML = tags.map(tag => `
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold text-white border border-white/10" 
                              style="background-color: ${tag.colorHex || '#555'}">
                            ${tag.name}
                            <button onclick="removeTag(${tag.id})" class="hover:text-black/50 ml-1 rounded-full bg-black/20 w-4 h-4 flex items-center justify-center">
                                &times;
                            </button>
                        </span>
                    `).join('');
                } catch (e) {
                    console.error(e);
                    container.innerHTML = '<span class="text-red-400 text-xs">Error loading tags</span>';
                }
            }

            // 2. Tìm kiếm Tag
            async function handleTagSearch(query) {
                currentTagSearchTerm = query.trim();
                const resultBox = document.getElementById('tagSearchResults');
                const createBox = document.getElementById('createTagOption');
                const newNameSpan = document.getElementById('newTagName');

                if (query.length < 1) {
                    resultBox.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">Type to search tags.</p>';
                    createBox.classList.add('hidden');
                    return;
                }

                try {
                    const res = await fetch(`/subjects/tags/search?q=${encodeURIComponent(query)}`);
                    const tags = await res.json();

                    // Hiển thị kết quả tìm kiếm
                    if (tags.length > 0) {
                        resultBox.innerHTML = tags.map(tag => `
                            <button onclick="addTag(${tag.id})" class="w-full flex items-center gap-3 p-2 rounded hover:bg-white/5 text-left group transition-colors">
                                <div class="w-3 h-3 rounded-full" style="background-color: ${tag.colorHex || '#833cf6'}"></div>
                                <span class="text-sm text-gray-300 group-hover:text-white flex-1">${tag.name}</span>
                                <span class="text-[10px] text-gray-500 font-mono">#${tag.slug}</span>
                            </button>
                        `).join('');
                    } else {
                        resultBox.innerHTML = '<p class="text-center text-gray-500 text-xs mt-4">No matches found.</p>';
                    }

                    // Logic hiển thị nút Create
                    // Luôn hiện nút create nếu query không rỗng (để user có thể tạo tag mới trùng tên nhưng khác ý nghĩa, hoặc đơn giản là tạo mới)
                    // Hoặc chỉ hiện khi không tìm thấy match chính xác. Ở đây ta luôn hiện để tiện.
                    newNameSpan.innerText = query;
                    createBox.classList.remove('hidden');

                } catch (e) {
                    console.error(e);
                }
            }

            // 3. Add Tag
            async function addTag(tagId) {
                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const formData = new FormData();
                    formData.append('fileId', rightClickedFileId);
                    formData.append('tagId', tagId);

                    await fetch('/subjects/media/tags/add', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken},
                        body: formData
                    });

                    loadFileTags(); // Reload list
                    // Clear search
                    document.getElementById('tagSearchInput').value = '';
                    handleTagSearch('');
                } catch (e) {
                    console.error(e);
                }
            }

            // 4. Remove Tag
            async function removeTag(tagId) {
                if (!confirm("Unlink this tag?"))
                    return;
                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const formData = new FormData();
                    formData.append('fileId', rightClickedFileId);
                    formData.append('tagId', tagId);

                    await fetch('/subjects/media/tags/remove', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken},
                        body: formData
                    });

                    loadFileTags();
                } catch (e) {
                    console.error(e);
                }
            }

            // 5. Create New Tag
            async function createNewTag() {
                if (!currentTagSearchTerm)
                    return;

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const formData = new FormData();
                    formData.append('name', currentTagSearchTerm);

                    const res = await fetch('/subjects/tags/create-quick', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken},
                        body: formData
                    });

                    if (res.ok) {
                        const newTag = await res.json();
                        // Sau khi tạo xong, add luôn vào file hiện tại
                        addTag(newTag.id);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Failed to create tag");
                }
            }
        </script>
        <script>
            // --- DOWNLOAD LOGIC ---

// 1. Tải 1 file (Từ context menu)
            function downloadSingleMedia() {
                mediaMenu.classList.add('hidden');
                if (!rightClickedFileId)
                    return;

                // Tạo thẻ a ảo để trigger download
                const link = document.createElement('a');
                link.href = `/subjects/media/download/${rightClickedFileId}`;
                link.target = '_blank'; // Mở tab mới để tải tránh gián đoạn UI
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

// 2. Tải nhiều file (Từ toolbar)
            async function downloadBatchMedia() {
                const ids = getSelectedIds();
                if (ids.length === 0)
                    return;

                const btn = document.getElementById('btnBatchDownload');
                const oldHtml = btn.innerHTML;
                btn.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">sync</span> Zipping...';
                btn.disabled = true;

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');

                    const response = await fetch('/subjects/media/download-batch', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify(ids)
                    });

                    if (response.ok) {
                        // Nhận blob từ response (file zip)
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `batch_download_${new Date().getTime()}.zip`; // Tên file zip
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    } else {
                        alert("Batch download failed.");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Download error.");
                } finally {
                    btn.innerHTML = oldHtml;
                    btn.disabled = false;
                    exitSelectionMode(); // Thoát chế độ chọn sau khi tải
                }
            }

// Helper: Lấy list ID đang chọn
            function getSelectedIds() {
                let ids = [];
                if (isSelectionMode) {
                    document.querySelectorAll('.selection-checkbox input:checked').forEach(cb => {
                        const parentA = cb.closest('a');
                        if (parentA)
                            ids.push(parentA.getAttribute('data-id'));
                    });
                } else if (rightClickedFileId) {
                    ids.push(rightClickedFileId);
                }
                return ids;
            }

// --- RENAME LOGIC ---

            function openRenameModal() {
                mediaMenu.classList.add('hidden');
                if (!rightClickedFileId)
                    return;

                // Lấy tên hiện tại từ UI để điền vào input
                const card = document.getElementById('file-card-' + rightClickedFileId);
                const currentName = card.querySelector('.file-name').innerText;

                document.getElementById('inputNewFileName').value = currentName;
                document.getElementById('checkRenamePhysical').checked = true; // Reset checkbox
                document.getElementById('renameMediaModal').showModal();
            }

            async function executeRenameMedia() {
                const newName = document.getElementById('inputNewFileName').value.trim();
                if (!newName)
                    return alert("Filename cannot be empty");

                const physical = document.getElementById('checkRenamePhysical').checked;
                const btn = document.getElementById('btnExecRename');
                btn.disabled = true;
                btn.innerText = "Saving...";

                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                    const formData = new FormData();
                    formData.append('fileId', rightClickedFileId);
                    formData.append('newName', newName);
                    formData.append('renamePhysical', physical);

                    const res = await fetch('/subjects/media/rename', {
                        method: 'POST',
                        headers: {'X-CSRF-TOKEN': csrfToken},
                        body: formData
                    });

                    if (res.ok) {
                        const finalName = await res.text();

                        // Cập nhật UI ngay lập tức
                        const card = document.getElementById('file-card-' + rightClickedFileId);
                        if (card) {
                            card.querySelector('.file-name').innerText = finalName;
                            // Update EXT badge nếu cần thiết
                            if (finalName.includes('.')) {
                                const ext = finalName.split('.').pop();
                                // Tìm badge ext (div absolute top-2)
                                // Ở đây update đơn giản, nếu cấu trúc HTML phức tạp hơn thì querySelector chính xác hơn
                            }
                        }

                        document.getElementById('renameMediaModal').close();
                    } else {
                        alert("Rename failed: " + await res.text());
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error renaming file");
                } finally {
                    btn.disabled = false;
                    btn.innerText = "Save";
                }
            }
        </script>
    </body>
</html>