<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(#{app.title.dashboard}, 'dashboard', ~{::section}, ~{::script})}">
    <body>

        <section class="flex-1 flex flex-col relative overflow-hidden bg-background-dark">
            <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <div class="flex items-center gap-2 text-sm">
                    <span class="text-[#a79cba]">Home</span>
                    <span class="material-symbols-outlined text-[#a79cba] text-[16px]">chevron_right</span>
                    <span class="font-bold text-white bg-[#2e2839] px-2 py-1 rounded" th:text="${currentFolder != null ? currentFolder.name : 'Root'}">Root</span>
                </div>
                <div class="flex items-center gap-4 flex-1 justify-center max-w-lg mx-4">
                    <div class="relative w-full group">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#a79cba]">search</span>
                        <input class="w-full bg-[#1e1926] border border-white/5 rounded-full pl-10 pr-10 py-2 text-sm text-white placeholder-[#a79cba] focus:outline-none focus:ring-2 focus:ring-primary/50" 
                               th:placeholder="#{dashboard.search.placeholder}" type="text"/>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 scroll-smooth" onclick="closeContextMenu()">

                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-white text-lg font-bold">Folders</h2>
                        <button onclick="openCreateFolder()" class="text-xs flex items-center gap-1 text-gray-400 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-sm">create_new_folder</span> New Folder
                        </button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <a th:if="${currentFolder != null}" th:href="@{/(folderId=${currentFolder.parentId})}"
                           class="flex items-center justify-center bg-white/5 rounded-xl p-4 border border-dashed border-gray-600 hover:bg-white/10 cursor-pointer transition-colors">
                            <span class="material-symbols-outlined text-gray-400">arrow_back</span>
                        </a>

                        <a th:each="item : ${items}" th:if="${item.isFolder()}" 
                           th:href="@{/(folderId=${item.id})}"
                           class="folder-card-gradient rounded-xl p-4 border border-white/5 hover:border-primary/50 cursor-pointer group transition-all duration-200">
                            <div class="flex justify-between items-start mb-3">
                                <span class="material-symbols-outlined text-[#a79cba] text-[32px] group-hover:text-primary transition-colors" style="font-variation-settings: 'FILL' 1;">folder</span>
                            </div>
                            <p class="text-white text-sm font-medium truncate" th:text="${item.name}">Name</p>
                        </a>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-purple-400">photo_library</span> Photos
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <div th:each="item : ${items}" th:if="${item.isImage()}" 
                             class="group relative aspect-square rounded-xl bg-[#2e2839] border border-white/5 hover:border-primary/50 overflow-hidden cursor-pointer shadow-lg transition-all"
                             th:attr="data-id=${item.id}, data-has-thumb='true'" 
                             oncontextmenu="openContextMenu(event, this)">

                            <img th:src="@{/api/file/thumbnail/{id}(id=${item.id})}" 
                                 class="w-full h-full object-cover transition-transform duration-500" loading="lazy"
                                 onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">

                            <div class="w-full h-full flex items-center justify-center bg-gray-800 hidden">
                                <span class="material-symbols-outlined text-4xl text-gray-500">image</span>
                            </div>

                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent p-3 pt-8 pointer-events-none">
                                <p class="text-white text-xs font-medium truncate" th:text="${item.name}">Name</p>
                                <p class="text-gray-400 text-[10px]" th:text="${item.readableSize}">Size</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-blue-400">movie</span> Videos
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <div th:each="item : ${items}" th:if="${item.isVideo()}" 
                             class="group relative aspect-video rounded-xl bg-[#2e2839] border border-white/5 hover:border-blue-500/50 overflow-hidden cursor-pointer shadow-lg transition-all"
                             th:attr="data-id=${item.id}, data-has-thumb='true'" 
                             oncontextmenu="openContextMenu(event, this)">

                            <img th:src="@{/api/file/thumbnail/{id}(id=${item.id})}" 
                                 class="w-full h-full object-cover transition-transform duration-500 opacity-80 group-hover:opacity-100" loading="lazy"
                                 onerror="this.style.display='none';">

                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                                <div class="w-12 h-12 rounded-full bg-black/40 backdrop-blur-sm flex items-center justify-center border border-white/20 group-hover:bg-primary/80 transition-colors">
                                    <span class="material-symbols-outlined text-white text-3xl drop-shadow-md">play_arrow</span>
                                </div>
                            </div>

                            <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md text-white text-[10px] font-mono font-bold px-1.5 py-0.5 rounded border border-white/10 z-20">
                                <span class="video-duration-tag" th:data-id="${item.id}">...</span>
                            </div>

                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 via-black/60 to-transparent p-3 pt-6 pointer-events-none z-20">
                                <p class="text-white text-xs font-medium truncate" th:text="${item.name}">Name</p>
                                <p class="text-gray-400 text-[10px]" th:text="${item.readableSize}">Size</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <aside id="detailsPanel" class="glass-panel fixed right-0 top-0 h-screen w-80 flex flex-col border-l border-white/10 overflow-y-auto no-scrollbar z-40 bg-[#171022] shadow-2xl translate-x-full transition-transform duration-300 ease-in-out">
                <div class="p-6 flex flex-col gap-6 pt-20">
                    <div class="flex items-center justify-between">
                        <h3 class="text-white font-bold text-base" th:text="#{dashboard.details.title}">Details</h3>
                        <button onclick="closeDetails()" class="text-[#a79cba] hover:text-white transition-colors"><span class="material-symbols-outlined">close</span></button>
                    </div>

                    <div class="flex flex-col gap-3">
                        <div class="aspect-video w-full rounded-lg bg-gray-800 border border-white/10 relative group overflow-hidden flex items-center justify-center">
                            <img id="detailPreview" src="" class="w-full h-full object-contain hidden">
                            <span id="detailIcon" class="material-symbols-outlined text-5xl text-gray-500">description</span>
                        </div>
                        <div>
                            <h2 id="detailName" class="text-white font-bold text-lg leading-tight break-words">Filename</h2>
                            <p id="detailSize" class="text-[#a79cba] text-sm mt-1">Size</p>
                        </div>
                    </div>
                    <div class="h-px bg-white/10 w-full"></div>
                    <div class="flex flex-col gap-4">
                        <h4 class="text-white text-sm font-bold" th:text="#{dashboard.details.info}">Information</h4>
                        <div class="flex flex-col gap-3" id="metaContainer">
                            <p class="text-gray-500 text-xs italic">Select 'Properties' to view details.</p>
                        </div>
                    </div>
                </div>
            </aside>

            <div id="contextMenu" class="hidden fixed z-50 w-48 bg-[#1e1e1e] border border-white/10 rounded-lg shadow-xl overflow-hidden">
                <button onclick="alert('Preview')" class="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-[#833cf6] hover:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">visibility</span> Preview
                </button>
                <button onclick="viewProperties()" class="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-[#833cf6] hover:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">info</span> Properties
                </button>
                <div class="h-px bg-white/10 mx-2 my-1"></div>
                <button class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-red-500/20 flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">delete</span> Delete
                </button>
            </div>

            <dialog id="createFolderModal" class="bg-[#1e1e1e] text-white p-6 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/50">
                <h3 class="text-lg font-bold mb-4">Create Folder</h3>
                <form th:action="@{/folder/create}" method="post" class="flex flex-col gap-4">
                    <input type="hidden" name="parentId" th:value="${currentFolderId}">
                    <input type="text" name="name" placeholder="Name" class="bg-black/50 border border-gray-600 rounded px-3 py-2 text-white">
                    <div class="flex gap-2 justify-end">
                        <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel</button>
                        <button type="submit" class="bg-primary px-4 py-2 rounded text-sm font-bold">Create</button>
                    </div>
                </form>
            </dialog>
            <form id="uploadForm" th:action="@{/file/upload}" method="post" enctype="multipart/form-data" class="hidden">
                <input type="hidden" name="parentId" th:value="${currentFolderId}">
                <input type="file" name="file" id="fileInput" onchange="document.getElementById('uploadForm').submit()">
            </form>

        </section>

        <script>
            // --- GLOBAL FUNCTIONS FOR LAYOUT ---
            window.triggerUpload = function () {
                document.getElementById('fileInput').click();
            }

            // --- LOCAL FUNCTIONS ---
            function openCreateFolder() {
                document.getElementById('createFolderModal').showModal();
            }

            // Context Menu Logic
            let selectedFileId = null;
            let hasThumb = false;
            const contextMenu = document.getElementById('contextMenu');
            const detailsPanel = document.getElementById('detailsPanel');

            window.openContextMenu = function (e, element) {
                e.preventDefault();
                e.stopPropagation();
                selectedFileId = element.getAttribute('data-id');
                hasThumb = element.getAttribute('data-has-thumb') === 'true';

                // Điều chỉnh vị trí menu nếu sát lề
                let x = e.pageX;
                let y = e.pageY;
                if (window.innerWidth - x < 200)
                    x -= 200;

                contextMenu.style.top = `${y}px`;
                contextMenu.style.left = `${x}px`;
                contextMenu.classList.remove('hidden');
            }

            function closeContextMenu() {
                contextMenu.classList.add('hidden');
            }

            document.addEventListener('click', function (e) {
                if (!contextMenu.contains(e.target))
                    closeContextMenu();
            });

            // Sidebar Details Logic
            function closeDetails() {
                detailsPanel.classList.remove('translate-x-0');
                detailsPanel.classList.add('translate-x-full');
            }

            // Format giây -> MM:SS
            function formatDuration(seconds) {
                if (!seconds)
                    return "";
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                return `${min}:${sec.toString().padStart(2, '0')}`;
            }

            function viewProperties() {
                closeContextMenu();
                detailsPanel.classList.remove('translate-x-full');
                detailsPanel.classList.add('translate-x-0');

                document.getElementById('detailName').innerText = "Loading...";
                document.getElementById('metaContainer').innerHTML = '<p class="text-gray-500 text-xs">Loading metadata...</p>';

                const img = document.getElementById('detailPreview');
                const icon = document.getElementById('detailIcon');

                if (hasThumb) {
                    img.src = `/api/file/thumbnail/${selectedFileId}`;
                    img.classList.remove('hidden');
                    icon.classList.add('hidden');
                } else {
                    img.classList.add('hidden');
                    icon.classList.remove('hidden');
                    icon.innerText = 'description';
                }

                fetch(`/api/file/metadata/${selectedFileId}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('detailName').innerText = data.name;
                            document.getElementById('detailSize').innerText = data.size;

                            if (!hasThumb)
                                icon.innerText = data.type.startsWith('video') ? 'movie' : 'description';

                            const container = document.getElementById('metaContainer');
                            container.innerHTML = '';
                            const addRow = (label, value) => {
                                if (value == null || value === '')
                                    return;
                                container.innerHTML += `<div class="flex justify-between items-center text-sm py-1 border-b border-white/5 last:border-0"><span class="text-[#a79cba]">${label}</span><span class="text-white font-medium truncate max-w-[160px]" title="${value}">${value}</span></div>`;
                            };

                            addRow("Type", data.type);
                            addRow("Uploaded", data.created ? new Date(data.created).toLocaleDateString() : "");

                            if (data.meta && data.meta !== "N/A") {
                                const m = data.meta;
                                if (m.width && m.height)
                                    addRow("Dimensions", `${m.width} x ${m.height}`);
                                if (m.durationSeconds)
                                    addRow("Duration", formatDuration(m.durationSeconds));
                                if (m.videoCodec)
                                    addRow("Codec", m.videoCodec.toUpperCase());
                                if (m.takenAt)
                                    addRow("Taken", new Date(m.takenAt).toLocaleDateString());
                                if (m.locationName)
                                    addRow("Location", m.locationName);
                            }
                        })
                        .catch(err => console.error(err));
            }

            // Load Video Durations on Load
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.video-duration-tag').forEach(tag => {
                    const fileId = tag.getAttribute('data-id');
                    if (fileId) {
                        fetch(`/api/file/metadata/${fileId}`)
                                .then(res => res.json())
                                .then(data => {
                                    if (data.meta && data.meta.durationSeconds)
                                        tag.innerText = formatDuration(data.meta.durationSeconds);
                                    else
                                        tag.parentElement.style.display = 'none';
                                }).catch(() => {
                        });
                    }
                });
            });
        </script>

    </body>
</html>