<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Movies Library', 'movies', ~{::section}, ~{::script})}">
    <body>
        <section class="flex-1 flex flex-col relative overflow-hidden">

            <div class="border-b border-white/5 z-20 sticky top-0 shadow-xl bg-background-dark">
                <div class="h-16 flex items-center justify-between px-4 md:px-6 gap-3">
                    <div class="flex items-center gap-3 shrink-0">
                        <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white"><span class="material-symbols-outlined text-2xl">menu</span></button>
                        <h2 class="text-lg md:text-xl font-bold text-white hidden sm:flex items-center gap-2">
                            <span class="hidden md:inline">Movie Library</span>
                        </h2>
                    </div>

                    <div class="flex-1 max-w-xl relative">
                        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">search</span>
                        <input type="text" form="mainFilterForm" name="keyword" th:value="${keyword}" 
                               class="w-full bg-[#252525] border border-white/10 rounded-full py-2 pl-10 pr-10 text-sm text-white focus:outline-none focus:border-primary/50 transition-all placeholder-gray-600"
                               placeholder="Search movies...">

                        <button type="button" onclick="openFilterModal()" 
                                class="absolute right-1 top-1/2 flex items-center -translate-y-1/2 p-1.5 rounded-full hover:bg-white/10 text-gray-400 hover:text-primary transition-colors"
                                title="Open Filters">
                            <span class="material-symbols-outlined text-[20px]" th:classappend="${selectedYear != null || selectedStudio != null || (selectedTags != null && !selectedTags.isEmpty())} ? 'text-primary fill-current' : ''">tune</span>
                        </button>
                    </div>

                    <a href="/movies/add" class="bg-primary hover:bg-primary-dark text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 text-sm shadow-lg shadow-primary/20 transition-all shrink-0">
                        <span class="material-symbols-outlined text-[20px]">add</span> <span class="hidden md:inline">Add</span>
                    </a>
                </div>

                <div class="px-4 md:px-6 pb-2 flex flex-wrap gap-2" th:if="${selectedYear != null || selectedStudio != null || (selectedTags != null && !selectedTags.isEmpty())}">
                    <span th:if="${selectedYear}" class="text-[10px] bg-white/5 border border-white/10 text-gray-300 px-2 py-0.5 rounded-full flex items-center gap-1">
                        Year: <b th:text="${selectedYear}"></b>
                    </span>
                    <a href="/movies" class="text-[10px] text-red-400 hover:text-red-300 hover:underline flex items-center ml-auto">Clear All</a>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-6 scroll-smooth">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 md:gap-5">
                    <a th:each="movie : ${movies}" th:href="@{/movies/{id}(id=${movie.id})}"
                       class="group relative aspect-[2/3] bg-[#2e2839] rounded-xl overflow-hidden border border-white/5 hover:border-primary/50 transition-all shadow-lg shadow-primary/5 hover:shadow-primary/20">
                        <img th:src="@{/movies/image/{id}(id=${movie.id}, thumb=true)}" 
                             loading="lazy"
                             class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 img-blur"
                             onerror="this.src='https://placehold.co/300x450/1e1e1e/FFF?text=No+Cover'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/40 to-transparent opacity-100 transition-opacity flex flex-col justify-end p-3">
                            <h3 class="text-white font-bold text-xs md:text-sm leading-tight line-clamp-2 mb-1 group-hover:text-primary transition-colors" th:text="${movie.title}">Title</h3>
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 text-[10px] md:text-xs font-mono" th:text="${movie.releaseYear}">2024</span>
                                <span th:if="${!movie.studios.isEmpty()}" class="hidden md:inline-block text-[10px] text-gray-500 truncate max-w-[80px]" th:text="${movie.studios[0].name}">Studio</span>
                            </div>
                        </div>
                        <div class="absolute top-2 left-2 right-2 flex justify-between items-start">
                            <div th:if="${movie.rating > 0}" class="bg-black/60 backdrop-blur-md text-yellow-400 text-[10px] font-bold px-1.5 py-0.5 rounded flex items-center gap-0.5 border border-yellow-500/20">
                                <span class="material-symbols-outlined text-[10px] fill-current">star</span> <span th:text="${movie.rating}"></span>
                            </div>
                            <div th:if="${!movie.tags.isEmpty()}" th:style="'background-color:' + ${movie.tags[0].colorHex}" class="text-[9px] font-bold text-white px-1.5 py-0.5 rounded shadow-sm opacity-90 truncate max-w-[60px]" th:text="${movie.tags[0].name}">Tag</div>
                        </div>
                    </a>
                </div>
                <div th:if="${movies.isEmpty()}" class="flex flex-col items-center justify-center h-[50vh] text-gray-500">
                    <div class="w-20 h-20 bg-white/5 rounded-full flex items-center justify-center mb-4"><span class="material-symbols-outlined text-4xl opacity-50">search_off</span></div>
                    <p class="text-lg font-medium text-gray-400">No movies found</p>
                </div>
                <div th:if="${totalPages > 1}" class="flex justify-center mt-8 gap-2">
                    <button th:if="${currentPage > 0}" onclick="changePage(this.getAttribute('data-page'))" th:data-page="${currentPage - 1}" class="px-4 py-2 bg-[#252525] hover:bg-primary text-white text-sm rounded-lg transition-colors border border-white/10">Prev</button>
                    <span class="px-4 py-2 text-gray-500 text-sm" th:text="'Page ' + (${currentPage + 1}) + ' of ' + ${totalPages}"></span>
                    <button th:if="${currentPage < totalPages - 1}" onclick="changePage(this.getAttribute('data-page'))" th:data-page="${currentPage + 1}" class="px-4 py-2 bg-[#252525] hover:bg-primary text-white text-sm rounded-lg transition-colors border border-white/10">Next</button>
                </div>
            </div>

            <div id="filterModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeFilterModal()"></div>

                <div class="absolute right-0 top-0 h-full w-full max-w-sm bg-[#1a1a1a] shadow-2xl border-l border-white/10 flex flex-col transform transition-transform duration-300 translate-x-full" id="filterPanel">

                    <div class="p-5 border-b border-white/10 flex items-center justify-between bg-[#151515]">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">filter_list</span> Filters
                        </h3>
                        <button onclick="closeFilterModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
                    </div>

                    <form id="mainFilterForm" th:action="@{/movies}" method="get" class="flex-1 overflow-y-auto p-5 space-y-6">
                        <input type="hidden" name="keyword" th:value="${keyword}">
                        <input type="hidden" name="page" id="pageInput" value="0">

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Sort By</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="cursor-pointer">
                                    <input type="radio" name="sort" value="createdAt,desc" class="peer sr-only" th:checked="${selectedSort == 'createdAt,desc'}">
                                    <div class="bg-[#252525] peer-checked:bg-primary/20 peer-checked:text-primary peer-checked:border-primary text-gray-400 text-xs font-bold py-2 px-3 rounded-lg border border-white/5 text-center transition-all hover:bg-white/5">Newest Added</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="sort" value="releaseYear,desc" class="peer sr-only" th:checked="${selectedSort == 'releaseYear,desc'}">
                                    <div class="bg-[#252525] peer-checked:bg-primary/20 peer-checked:text-primary peer-checked:border-primary text-gray-400 text-xs font-bold py-2 px-3 rounded-lg border border-white/5 text-center transition-all hover:bg-white/5">Release Year</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="sort" value="rating,desc" class="peer sr-only" th:checked="${selectedSort == 'rating,desc'}">
                                    <div class="bg-[#252525] peer-checked:bg-primary/20 peer-checked:text-primary peer-checked:border-primary text-gray-400 text-xs font-bold py-2 px-3 rounded-lg border border-white/5 text-center transition-all hover:bg-white/5">Rating</div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="sort" value="title,asc" class="peer sr-only" th:checked="${selectedSort == 'title,asc'}">
                                    <div class="bg-[#252525] peer-checked:bg-primary/20 peer-checked:text-primary peer-checked:border-primary text-gray-400 text-xs font-bold py-2 px-3 rounded-lg border border-white/5 text-center transition-all hover:bg-white/5">Name (A-Z)</div>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Release Year</label>
                            <select name="year" class="w-full bg-[#252525] text-white text-sm rounded-lg px-4 py-2.5 border border-white/10 outline-none focus:border-primary">
                                <option value="">All Years</option>
                                <option th:each="y : ${allYears}" th:value="${y}" th:text="${y}" th:selected="${selectedYear == y}"></option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Studio</label>
                            <select name="studio" class="w-full bg-[#252525] text-white text-sm rounded-lg px-4 py-2.5 border border-white/10 outline-none focus:border-primary">
                                <option value="">All Studios</option>
                                <option th:each="s : ${allStudios}" th:value="${s.id}" th:text="${s.name}" th:selected="${selectedStudio == s.id}"></option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tags / Genres</label>
                            <div class="bg-[#252525] border border-white/10 rounded-lg overflow-hidden">
                                <div class="p-2 border-b border-white/5 flex items-center gap-2">
                                    <span class="material-symbols-outlined text-gray-500 text-lg">search</span>
                                    <input type="text" id="tagSearchInput" placeholder="Filter tags..." 
                                           class="bg-transparent border-none text-xs text-white w-full outline-none placeholder-gray-600"
                                           onkeyup="filterTags()">
                                </div>
                                <div class="max-h-40 overflow-y-auto p-2 space-y-1 custom-scrollbar">
                                    <label th:each="t : ${allTags}" class="flex items-center gap-2 p-1.5 hover:bg-white/5 rounded cursor-pointer tag-item">
                                        <input type="checkbox" name="tags" th:value="${t.id}" 
                                               th:checked="${selectedTags != null && selectedTags.contains(t.id)}"
                                               class="accent-primary w-4 h-4 rounded border-gray-600 bg-[#1a1a1a]">
                                        <span class="text-sm text-gray-300 select-none" th:text="${t.name}">Action</span>
                                    </label>
                                </div>
                            </div>
                            <p class="text-[10px] text-gray-500 mt-1">Select multiple tags to filter.</p>
                        </div>
                    </form>

                    <div class="p-5 border-t border-white/10 bg-[#151515] flex gap-3">
                        <a href="/movies" class="flex-1 py-2.5 text-center text-sm font-bold text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg transition-colors">Reset</a>
                        <button type="submit" form="mainFilterForm" class="flex-[2] py-2.5 text-center text-sm font-bold text-white bg-primary hover:bg-primary-dark rounded-lg shadow-lg shadow-primary/20 transition-all">Apply Filters</button>
                    </div>
                </div>
            </div>

        </section>

        <script>
            // --- FILTER MODAL LOGIC ---
            function openFilterModal() {
                const modal = document.getElementById('filterModal');
                const panel = document.getElementById('filterPanel');
                modal.classList.remove('hidden');
                // Animation slide in
                setTimeout(() => {
                    panel.classList.remove('translate-x-full');
                }, 10);
            }

            function closeFilterModal() {
                const modal = document.getElementById('filterModal');
                const panel = document.getElementById('filterPanel');
                panel.classList.add('translate-x-full');
                // Wait animation
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }

            // --- TAG FILTER SEARCH ---
            function filterTags() {
                const input = document.getElementById('tagSearchInput');
                const filter = input.value.toLowerCase();
                const items = document.querySelectorAll('.tag-item');

                items.forEach(item => {
                    const text = item.querySelector('span').textContent.toLowerCase();
                    if (text.includes(filter)) {
                        item.style.display = "";
                    } else {
                        item.style.display = "none";
                    }
                });
            }

            // --- PAGINATION ---
            function changePage(page) {
                document.getElementById('pageInput').value = page;
                document.getElementById('mainFilterForm').submit();
            }

        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Tìm tất cả ảnh có class 'img-blur'
                const lazyImages = document.querySelectorAll('.img-blur');

                lazyImages.forEach(img => {
                    // Nếu ảnh đã load xong từ cache -> hiện luôn
                    if (img.complete) {
                        img.classList.add('img-loaded');
                    } else {
                        // Nếu chưa -> chờ sự kiện onload
                        img.onload = () => {
                            img.classList.add('img-loaded');
                        };
                    }
                });
            });
        </script>
        <style>
            /* Custom Scrollbar for Tags List */
            .custom-scrollbar::-webkit-scrollbar {
                width: 4px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #1a1a1a;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #333;
                border-radius: 2px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        </style>
        <style>
            /* Trạng thái ban đầu: Mờ và trong suốt */
            .img-blur {
                filter: blur(20px);
                opacity: 0;
                transform: scale(1.1); /* Zoom nhẹ để tránh viền trắng khi blur */
                transition: filter 0.5s ease-out, opacity 0.5s ease-out, transform 0.5s ease-out;
                will-change: filter, opacity, transform;
            }

            /* Trạng thái sau khi load xong: Rõ nét */
            .img-loaded {
                filter: blur(0);
                opacity: 1;
                transform: scale(1);
            }
        </style>
    </body>
</html>