<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/video_layout :: layout(|${movie.title} - ${episode.title}|, ~{::div.grid-container}, ~{::#page-scripts})}">
    <body>
        <div id="mainGrid" class="grid-container grid grid-cols-1 lg:grid-cols-4 gap-4 lg:gap-8 p-3 lg:p-8">

            <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden transition-opacity duration-300" onclick="closeSidebar()"></div>

            <button id="playlistFab" onclick="openSidebar()"
                    class="fixed bottom-6 right-6 z-[50] size-12 lg:hidden rounded-full bg-primary hover:bg-primary-hover text-white shadow-2xl flex items-center justify-center transition-transform hover:scale-110">
                <span class="material-symbols-outlined text-2xl">list</span>
            </button>

            <div id="leftCol" class="lg:col-span-3 flex flex-col gap-4 lg:gap-6 transition-all duration-500">

                <div id="videoWrapper" class="relative w-full group select-none isolate transition-all z-50">
                    <canvas id="ambientCanvas"
                            class="absolute top-1/2 left-1/2 w-full h-full -z-10 transition-opacity duration-1000 opacity-0 pointer-events-none rounded-xl"
                            style="filter: blur(60px) saturate(200%); transform: translate(-50%, -50%) scale(1.15); mix-blend-mode: screen;"
                            width="100" height="60"></canvas>

                    <div id="videoContainer" class="relative w-full h-full bg-transparent rounded-xl overflow-hidden touch-manipulation">
                        <video id="mainPlayer" class="w-full aspect-video object-contain cursor-pointer bg-black" autoplay>
                            <source th:src="@{/movies/stream/{id}(id=${episode.id})}" th:type="${episode.mimeType ?: 'video/mp4'}">
                            Your browser does not support the video tag.
                        </video>

                        <div id="gradientOverlay" class="controls-layer absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10"></div>

                        <div id="mobileSeekLeft" class="absolute top-0 left-0 bottom-0 w-1/3 z-30 pointer-events-none flex items-center justify-center opacity-0 transition-opacity duration-200">
                            <div class="bg-black/60 backdrop-blur-sm rounded-full w-20 h-20 flex flex-col items-center justify-center text-white/90">
                                <span class="material-symbols-outlined text-3xl">fast_rewind</span>
                                <span id="mobileSeekLeftText" class="text-xs font-bold font-mono mt-1">-10s</span>
                            </div>
                            <div class="absolute inset-0 bg-white/5 animate-pulse rounded-r-full"></div>
                        </div>

                        <div id="mobileSeekRight" class="absolute top-0 right-0 bottom-0 w-1/3 z-30 pointer-events-none flex items-center justify-center opacity-0 transition-opacity duration-200">
                            <div class="bg-black/60 backdrop-blur-sm rounded-full w-20 h-20 flex flex-col items-center justify-center text-white/90">
                                <span class="material-symbols-outlined text-3xl">fast_forward</span>
                                <span id="mobileSeekRightText" class="text-xs font-bold font-mono mt-1">+10s</span>
                            </div>
                            <div class="absolute inset-0 bg-white/5 animate-pulse rounded-l-full"></div>
                        </div>

                        <div id="seekOverlay" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-center pointer-events-none opacity-0 transition-opacity duration-200 z-30">
                            <div class="bg-black/60 backdrop-blur-md px-6 py-3 rounded-full flex items-center gap-3 border border-white/10 shadow-2xl scale-110">
                                <span class="material-symbols-outlined text-white text-3xl" id="seekIcon">fast_forward</span>
                                <span class="text-white font-bold text-xl font-mono" id="seekText">5s >></span>
                            </div>
                        </div>

                        <div id="centerPlayBtn" class="controls-layer absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 size-16 md:size-20 bg-black/60 rounded-full flex items-center justify-center backdrop-blur-sm ring-1 ring-white/20 cursor-pointer hover:bg-black/80 hover:scale-110 transition-all z-20 hidden">
                            <span class="material-symbols-outlined text-white text-[32px] md:text-[48px]">play_arrow</span>
                        </div>

                        <div id="settingsMenu" class="controls-layer invisible opacity-0 transition-all duration-200 z-[70]
                             fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4
                             lg:absolute lg:inset-auto lg:bottom-20 lg:right-4 lg:bg-transparent lg:backdrop-blur-none lg:p-0 lg:block lg:w-auto lg:h-auto">

                            <div class="bg-[#1e1e1e]/95 backdrop-blur-xl rounded-xl border border-white/10 shadow-2xl overflow-hidden w-full max-w-sm lg:w-72 transform transition-transform scale-95 lg:scale-100"
                                 onclick="event.stopPropagation()">

                                <div class="lg:hidden flex justify-between items-center p-3 border-b border-white/5">
                                    <span class="text-white font-bold">Settings</span>
                                    <button onclick="closeSettings()" class="text-gray-400 hover:text-white">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>

                                <div class="p-2 space-y-1">
                                    <button id="toggleAmbientBtn" class="w-full flex items-center justify-between px-3 py-3 lg:py-2.5 rounded-lg hover:bg-white/10 transition-colors text-left group/btn">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-gray-300 group-hover/btn:text-primary text-[20px]">light_mode</span>
                                            <span class="text-white text-sm font-medium">Ambient Mode</span>
                                        </div>
                                        <div class="relative inline-flex h-5 w-9 items-center rounded-full bg-gray-600 transition-colors" id="ambientSwitchBg">
                                            <span class="translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform" id="ambientSwitchKnob"></span>
                                        </div>
                                    </button>

                                    <button id="toggleLoopBtn" class="w-full flex items-center justify-between px-3 py-3 lg:py-2.5 rounded-lg hover:bg-white/10 transition-colors text-left group/btn">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-gray-300 group-hover/btn:text-primary text-[20px]">repeat</span>
                                            <span class="text-white text-sm font-medium">Loop Video</span>
                                        </div>
                                        <div class="relative inline-flex h-5 w-9 items-center rounded-full bg-gray-600 transition-colors" id="loopSwitchBg">
                                            <span class="translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform" id="loopSwitchKnob"></span>
                                        </div>
                                    </button>

                                    <button id="toggleAutoplayBtn" class="w-full flex items-center justify-between px-3 py-3 lg:py-2.5 rounded-lg hover:bg-white/10 transition-colors text-left group/btn">
                                        <div class="flex items-center gap-3">
                                            <span class="material-symbols-outlined text-gray-300 group-hover/btn:text-primary text-[20px]">autoplay</span>
                                            <span class="text-white text-sm font-medium">Autoplay Next</span>
                                        </div>
                                        <div class="relative inline-flex h-5 w-9 items-center rounded-full bg-gray-600 transition-colors" id="autoplaySwitchBg">
                                            <span class="translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform" id="autoplaySwitchKnob"></span>
                                        </div>
                                    </button>

                                    <div class="px-3 py-2 rounded-lg hover:bg-white/5 transition-colors">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <span class="material-symbols-outlined text-gray-300 text-[20px]">update</span>
                                                <span class="text-white text-sm font-medium">Seek Time</span>
                                            </div>
                                            <span class="text-primary text-xs font-bold bg-primary/20 px-2 py-0.5 rounded" id="seekSettingValue">5s</span>
                                        </div>
                                        <div class="px-1 py-2">
                                            <input type="range" min="1" max="20" step="1" id="seekSettingSlider"
                                                   class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-primary hover:bg-white/40 transition-colors">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="bottomControls" class="controls-layer absolute bottom-0 left-0 w-full px-4 pb-4 pt-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 flex flex-col gap-2">
                            <div class="relative h-1.5 w-full bg-white/20 rounded-full cursor-pointer group/progress transition-all hover:h-2.5" id="progressContainer">
                                <div id="bufferBar" class="absolute top-0 left-0 h-full bg-white/30 rounded-full w-0 transition-all duration-300"></div>
                                <div id="progressBar" class="absolute top-0 left-0 h-full bg-primary rounded-full w-0 relative">
                                    <div class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-1/2 size-3 bg-white rounded-full scale-0 group-hover/progress:scale-100 transition-transform shadow-md"></div>
                                </div>
                                <input type="range" min="0" max="100" value="0" step="0.1" id="seekSlider" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 md:gap-4">
                                    <button id="playBtn" class="flex items-center text-white hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-[28px] md:text-[32px]" id="playIcon">play_arrow</span>
                                    </button>
                                    <div class="flex items-center gap-2 group/vol">
                                        <button id="muteBtn" class="flex items-center text-white hover:text-primary transition-colors">
                                            <span class="material-symbols-outlined text-[20px] md:text-[24px]" id="volumeIcon">volume_up</span>
                                        </button>
                                        <div class="w-0 overflow-hidden group-hover/vol:w-20 transition-all duration-300 flex items-center hidden md:flex">
                                            <input type="range" min="0" max="1" step="0.05" value="1" id="volumeSlider" class="w-20 h-1 bg-white/30 rounded-lg appearance-none cursor-pointer accent-primary hover:bg-white/50">
                                        </div>
                                    </div>
                                    <div class="text-[10px] md:text-xs font-medium font-mono text-gray-300">
                                        <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 md:gap-3">
                                    <button id="settingsBtn" class="flex items-center text-white hover:text-primary transition-colors rotate-0 transition-transform duration-300">
                                        <span class="material-symbols-outlined text-[20px] md:text-[24px]">settings</span>
                                    </button>
                                    <button id="theaterBtn" class="flex items-center text-white hover:text-primary transition-colors rotate-0 transition-transform duration-300" title="Theater Mode">
                                        <span class="material-symbols-outlined text-[24px]">rectangle</span>
                                    </button>
                                    <button id="fullscreenBtn" class="flex items-center text-white hover:text-primary transition-colors">
                                        <span class="material-symbols-outlined text-[24px] md:text-[28px]">fullscreen</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-4 mt-5">
                    <div class="flex flex-col">
                        <h1 class="text-white text-xl md:text-3xl lg:text-[2rem] font-bold leading-tight tracking-tight">
                            <span class="text-primary mr-2" th:text="|EP ${episode.episodeNumber}|">EP 1</span>
                            <span th:text="${episode.title != null && !episode.title.isEmpty() ? episode.title : 'Episode ' + episode.episodeNumber}">Episode Title</span>
                        </h1>
                        <h2 class="text-gray-400 text-sm md:text-lg font-medium hover:text-white transition-colors mt-1">
                            <a th:href="@{/movies/{id}(id=${movie.id})}" th:text="${movie.title}">Movie Name</a>
                            <span class="mx-2">•</span>
                            <span th:text="${movie.releaseYear}">2024</span>
                        </h2>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 pb-4 border-b border-white/5">
                        <div class="flex items-center gap-4">
                            <a th:href="@{/movies/{id}(id=${movie.id})}" class="relative cursor-pointer hover:opacity-80 transition-opacity group/cover shrink-0">
                                <div class="w-10 h-14 md:w-12 md:h-16 rounded-lg bg-cover bg-center ring-1 ring-white/10 overflow-hidden shadow-lg">
                                    <img th:src="@{/movies/image/{id}(id=${movie.id}, thumb=true)}" class="w-full h-full object-cover">
                                </div>
                            </a>

                            <div class="flex flex-col justify-center">
                                <div class="flex items-center gap-2 flex-wrap mb-1">
                                    <span th:if="${movie.studios.isEmpty()}" class="text-xs text-gray-500 italic">No Studio</span>
                                    <span th:each="studio : ${movie.studios}" 
                                          class="text-[10px] md:text-xs font-bold text-gray-300 bg-white/10 px-2 py-0.5 rounded hover:bg-primary hover:text-white cursor-pointer transition-colors border border-white/5"
                                          th:text="${studio.name}">Studio Name</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="material-symbols-outlined text-yellow-500 text-[16px]">star</span>
                                    <span class="text-white font-bold text-sm" th:text="${movie.rating ?: 'N/A'}">8.5</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-2 sm:mt-0">
                            <a th:href="@{/movies/{id}(id=${movie.id})}" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white text-xs md:text-sm font-bold rounded-full transition-colors flex items-center gap-2 border border-white/5">
                                <span class="material-symbols-outlined text-[18px]">info</span> Details
                            </a>
                        </div>
                    </div>

                    <div class="bg-surface-dark rounded-xl p-4 transition-colors group border border-white/5">
                        <div class="flex gap-3 text-xs md:text-sm font-bold text-white mb-3 items-center">
                            <span class="bg-primary/20 text-primary px-2 py-0.5 rounded text-[10px] border border-primary/20" 
                                  th:text="${episode.mimeType}">MP4</span>
                            <span class="text-gray-400" th:if="${episode.fileSize}" 
                                  th:text="${T(org.apache.commons.io.FileUtils).byteCountToDisplaySize(episode.fileSize)}">Size</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed whitespace-pre-line text-justify md:text-left" 
                           th:text="${movie.description ?: 'No description available.'}"></p>

                        <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-white/5">
                            <span th:each="tag : ${movie.tags}" 
                                  class="group/tag relative text-[10px] md:text-xs font-bold text-gray-400 border border-white/10 px-2.5 py-1 rounded-full hover:border-primary hover:text-primary hover:bg-primary/5 transition-all cursor-pointer">
                                <span th:text="${'#' + tag.name}">#Tag</span>
                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-[200px] hidden group-hover/tag:block z-50 pointer-events-none opacity-0 group-hover/tag:opacity-100 transition-opacity duration-200">
                                    <div class="bg-[#151515]/95 text-white text-[10px] p-2.5 rounded-lg shadow-xl border border-white/20 text-left backdrop-blur-md">
                                        <p class="font-mono text-primary text-[9px] uppercase tracking-wider mb-1 border-b border-white/10 pb-1">
                                            slug: <span th:text="${tag.slug}" class="text-gray-300">slug</span>
                                        </p>
                                        <p th:text="${tag.description ?: 'No description.'}" class="text-gray-300 font-normal leading-relaxed whitespace-normal"></p>
                                    </div>
                                    <div class="w-2 h-2 bg-[#151515] rotate-45 mx-auto -mt-1 border-r border-b border-white/20"></div>
                                </div>
                            </span>
                            <span th:if="${movie.tags.isEmpty()}" class="text-gray-600 italic text-xs">No tags</span>
                        </div>
                    </div>

                    <div class="mt-6 md:mt-8 pt-6 md:pt-8">
                        <h3 class="text-white text-lg md:text-xl font-bold mb-4 md:mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-yellow-500">movie</span> You might also like
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                            <a th:each="rec : ${recommendations}" th:href="@{/movies/{id}(id=${rec.id})}" 
                               class="group relative aspect-[2/3] rounded-xl overflow-hidden bg-[#2e2839] border border-white/5 hover:border-primary/50 transition-all">
                                <img th:src="@{/movies/image/{id}(id=${rec.id}, thumb=true)}" 
                                     class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-3 w-full">
                                    <p class="text-white font-bold text-xs md:text-sm truncate" th:text="${rec.title}">Title</p>
                                    <span class="text-[10px] text-gray-400" th:text="${rec.releaseYear}">Year</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div id="rightCol" class="
                 fixed top-0 right-0 h-screen w-80 bg-[#1e1e1e] z-[70] shadow-2xl transition-transform duration-300 transform translate-x-full p-3
                 lg:translate-x-0 lg:static lg:h-fit lg:w-auto lg:bg-transparent lg:shadow-none lg:p-0 lg:block lg:col-span-1
                 ">

                <div id="sidebarHeader" class="lg:hidden flex items-center justify-between border-b border-white/10 mb-2 pb-2">
                    <h3 class="text-white font-bold text-lg">Episodes</h3>
                    <button onclick="closeSidebar()" class="text-gray-400 hover:text-white">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <div class="flex items-center justify-between text-white pb-2 border-b border-white/5 lg:border-none">
                    <h3 class="font-bold text-lg hidden lg:block">Episodes</h3>
                    <span class="text-xs text-gray-400" th:text="${#lists.size(episodes) + ' eps'}">0 eps</span>
                </div>

                <div class="flex flex-col gap-2 max-h-[calc(100vh-150px)] overflow-y-auto pr-1 custom-scrollbar" id="playlistContainer">
                    <a th:each="ep : ${episodes}"
                       th:href="@{/movies/watch/{id}(id=${ep.id})}"
                       th:id="'video-' + ${ep.id}"
                       th:data-id="${ep.id}"
                       th:data-active="${ep.id == episode.id}"
                       class="playlist-item flex gap-3 group cursor-pointer p-2 rounded-xl transition-all duration-200 border border-transparent"
                       th:classappend="${ep.id == episode.id} ? 'bg-primary/20 border-l-4 border-l-primary' : 'hover:bg-surface-dark border-white/5'">

                        <div class="relative w-28 md:w-32 aspect-video rounded-lg overflow-hidden shrink-0 bg-black ring-1 ring-white/10">
                            <img th:src="@{/movies/episodes/image/{id}(id=${ep.id})}" 
                                 class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                                 onerror="this.src='https://placehold.co/160x90/1e1e1e/FFF?text=No+Thumb'">

                            <div th:if="${ep.durationSeconds}" class="absolute bottom-1 right-1 bg-black/80 px-1.5 py-0.5 rounded text-[10px] font-bold text-white shadow-sm">
                                <span th:text="${ep.durationSeconds / 60 + ':' + #numbers.formatInteger(ep.durationSeconds % 60, 2)}">00:00</span>
                            </div>

                            <div th:if="${ep.id == episode.id}" class="absolute inset-0 bg-black/40 flex items-center justify-center">
                                <span class="material-symbols-outlined text-white text-xl animate-pulse">equalizer</span>
                            </div>
                        </div>

                        <div class="flex flex-col py-1 min-w-0 justify-center flex-1">
                            <h4 class="text-white text-xs md:text-sm font-bold leading-tight mb-1 group-hover:text-primary transition-colors line-clamp-2"
                                th:classappend="${ep.id == episode.id} ? 'text-primary' : ''"
                                th:text="|Episode ${ep.episodeNumber}|">Episode 1</h4>
                            <div class="text-[10px] md:text-xs text-gray-500 truncate" th:text="${ep.title}">Title</div>
                        </div>
                    </a>
                </div>
            </div>

            <style>
                .idle-mode {
                    cursor: none !important;
                }
                .idle-mode .controls-layer {
                    opacity: 0 !important;
                }
                .idle-mode #settingsMenu {
                    visibility: hidden !important;
                    opacity: 0 !important;
                }

                .custom-scrollbar::-webkit-scrollbar {
                    width: 4px;
                }
                .custom-scrollbar::-webkit-scrollbar-track {
                    background: transparent;
                }
                .custom-scrollbar::-webkit-scrollbar-thumb {
                    background: #333;
                    border-radius: 2px;
                }
                .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                    background: #555;
                }

                .fullscreen-mode #gradientOverlay {
                    display: none !important;
                }
                .fullscreen-mode #bottomControls {
                    opacity: 0 !important;
                    padding-top: 80px !important;
                    transition: opacity 0.3s ease;
                }
                .fullscreen-mode #bottomControls:hover {
                    opacity: 1 !important;
                    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
                }
            </style>
        </div>

    <th:block id="page-scripts">
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                // --- 1. KHAI BÁO BIẾN (VARIABLES) ---
                let animationFrameId, idleTimer, feedbackTimeout, mobileFeedbackTimeout, clickTimeout;

                // Player Elements
                const video = document.getElementById('mainPlayer');
                const videoWrapper = document.getElementById('videoWrapper');
                const videoContainer = document.getElementById('videoContainer');
                const canvas = document.getElementById('ambientCanvas');

                // Controls
                const playBtn = document.getElementById('playBtn');
                const playIcon = document.getElementById('playIcon');
                const centerPlayBtn = document.getElementById('centerPlayBtn');
                const seekSlider = document.getElementById('seekSlider');
                const progressBar = document.getElementById('progressBar');
                const bufferBar = document.getElementById('bufferBar');
                const currentTimeElem = document.getElementById('currentTime');
                const durationElem = document.getElementById('duration');
                const muteBtn = document.getElementById('muteBtn');
                const volumeIcon = document.getElementById('volumeIcon');
                const volumeSlider = document.getElementById('volumeSlider');
                const fullscreenBtn = document.getElementById('fullscreenBtn');
                const theaterBtn = document.getElementById('theaterBtn');

                // Settings & Feedback Elements
                const settingsBtn = document.getElementById('settingsBtn');
                const settingsMenu = document.getElementById('settingsMenu');
                const seekOverlay = document.getElementById('seekOverlay');
                const seekText = document.getElementById('seekText');
                const seekIcon = document.getElementById('seekIcon');

                // Mobile Specific Elements
                const mobileSeekLeft = document.getElementById('mobileSeekLeft');
                const mobileSeekRight = document.getElementById('mobileSeekRight');
                const mobileSeekLeftText = document.getElementById('mobileSeekLeftText');
                const mobileSeekRightText = document.getElementById('mobileSeekRightText');

                // Settings Toggles
                const toggleAmbientBtn = document.getElementById('toggleAmbientBtn');
                const ambientSwitchBg = document.getElementById('ambientSwitchBg');
                const ambientSwitchKnob = document.getElementById('ambientSwitchKnob');
                const toggleLoopBtn = document.getElementById('toggleLoopBtn');
                const loopSwitchBg = document.getElementById('loopSwitchBg');
                const loopSwitchKnob = document.getElementById('loopSwitchKnob');
                const toggleAutoplayBtn = document.getElementById('toggleAutoplayBtn');
                const autoplaySwitchBg = document.getElementById('autoplaySwitchBg');
                const autoplaySwitchKnob = document.getElementById('autoplaySwitchKnob');
                const seekSettingSlider = document.getElementById('seekSettingSlider');
                const seekSettingValue = document.getElementById('seekSettingValue');

                // Layout Elements
                const leftCol = document.getElementById('leftCol');
                const rightCol = document.getElementById('rightCol');
                const playlistFab = document.getElementById('playlistFab');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const ctx = canvas.getContext('2d', {alpha: false, desynchronized: true});

                // --- 2. QUẢN LÝ TRẠNG THÁI (STATE) ---
                let isLoop = localStorage.getItem('isLoop') === 'true';
                let isAutoplay = localStorage.getItem('isAutoplay') === 'true';
                let isTheater = localStorage.getItem('isTheater') === 'true';
                let isAmbientOn = localStorage.getItem('ambientMode') !== 'false';
                let seekStep = parseInt(localStorage.getItem('seekStep')) || 5;

                // --- 3. XỬ LÝ SỰ KIỆN CLICK & TOUCH (CORE LOGIC) ---

                // Hàm xử lý Click đơn (Play/Pause) có độ trễ để chờ Double Tap
                const handleSingleClick = (e) => {
                    // Bỏ qua nếu click vào nút controls, settings hoặc input
                    if (e.target.closest('button') || e.target.closest('input') || e.target.closest('#settingsMenu'))
                        return;

                    // Nếu đang chờ click trước đó thì clear
                    if (clickTimeout)
                        clearTimeout(clickTimeout);

                    // Chờ 300ms, nếu không có cú tap thứ 2 thì mới Play/Pause
                    clickTimeout = setTimeout(() => {
                        togglePlay();
                    }, 300);
                };
                // Gán sự kiện click cho container (thay vì video tag) để bắt tốt hơn
                videoContainer.addEventListener('click', handleSingleClick);

                // Hàm xử lý Double Tap trên Mobile
                let lastTapTime = 0;
                videoContainer.addEventListener('touchstart', (e) => {
                    if (e.target.closest('button') || e.target.closest('input') || e.target.closest('#settingsMenu'))
                        return;

                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTapTime;

                    // Nếu khoảng cách giữa 2 lần chạm < 300ms -> Là Double Tap
                    if (tapLength < 300 && tapLength > 0) {
                        e.preventDefault();

                        // [QUAN TRỌNG] Hủy lệnh Single Click đang chờ (Video sẽ không bị dừng)
                        if (clickTimeout) {
                            clearTimeout(clickTimeout);
                            clickTimeout = null;
                        }

                        // Tính toán vị trí chạm
                        const rect = videoContainer.getBoundingClientRect();
                        const touchX = e.touches[0].clientX - rect.left;
                        const width = rect.width;

                        if (touchX < width * 0.35) {
                            // Vùng Trái (35%) -> Tua Lùi
                            // Tham số true: Ẩn feedback ở giữa màn hình
                            performSeek(-seekStep, true);
                            showMobileFeedback(mobileSeekLeft, `-${seekStep}s`);
                        } else if (touchX > width * 0.65) {
                            // Vùng Phải (35%) -> Tua Tới
                            performSeek(seekStep, true);
                            showMobileFeedback(mobileSeekRight, `+${seekStep}s`);
                        } else {
                            // Vùng Giữa -> Vẫn cho phép Play/Pause ngay lập tức nếu double tap ở giữa
                            togglePlay();
                        }
                    }
                    lastTapTime = currentTime;
                });

                // Hiển thị hiệu ứng tua 2 bên (Mobile)
                function showMobileFeedback(element, text) {
                    if (text) {
                        if (element === mobileSeekLeft)
                            mobileSeekLeftText.innerText = text;
                        if (element === mobileSeekRight)
                            mobileSeekRightText.innerText = text;
                    }
                    element.classList.remove('opacity-0');
                    clearTimeout(mobileFeedbackTimeout);
                    mobileFeedbackTimeout = setTimeout(() => {
                        element.classList.add('opacity-0');
                    }, 500);
                }

                // --- 4. CÁC HÀM PLAYER CƠ BẢN ---

                function togglePlay(e) {
                    if (e)
                        e.stopPropagation();
                    if (video.paused || video.ended)
                        video.play();
                    else
                        video.pause();
                }

                // [UPDATED] Hàm tua video (Thêm tham số suppressCenterFeedback)
                function performSeek(seconds, suppressCenterFeedback = false) {
                    if (seconds > 0) {
                        video.currentTime = Math.min(video.duration, video.currentTime + seconds);
                        if (!suppressCenterFeedback)
                            showSeekFeedback('forward');
                    } else {
                        video.currentTime = Math.max(0, video.currentTime + seconds);
                        if (!suppressCenterFeedback)
                            showSeekFeedback('backward');
                    }

                    if (isAmbientOn)
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resetIdleTimer();
                }

                function showSeekFeedback(direction) {
                    const iconName = direction === 'forward' ? 'fast_forward' : 'fast_rewind';
                    seekText.innerText = direction === 'forward' ? `${seekStep}s` : `${seekStep}s`;
                    seekIcon.innerText = iconName;
                    seekOverlay.classList.remove('opacity-0', 'scale-90');
                    seekOverlay.classList.add('opacity-100', 'scale-110');
                    clearTimeout(feedbackTimeout);
                    feedbackTimeout = setTimeout(() => {
                        seekOverlay.classList.remove('opacity-100', 'scale-110');
                        seekOverlay.classList.add('opacity-0', 'scale-90');
                    }, 600);
                }

                // --- 5. EVENT LISTENERS (PLAYER UI) ---

                video.addEventListener('play', () => {
                    playIcon.innerText = 'pause';
                    centerPlayBtn.classList.add('hidden');
                    startAmbientLoop();
                    resetIdleTimer();
                });

                video.addEventListener('pause', () => {
                    playIcon.innerText = 'play_arrow';
                    centerPlayBtn.classList.remove('hidden');
                    stopAmbientLoop();
                    videoWrapper.classList.remove('idle-mode');
                });

                video.addEventListener('ended', () => {
                    playIcon.innerText = 'replay';
                    centerPlayBtn.classList.remove('hidden');
                    stopAmbientLoop();
                    videoWrapper.classList.remove('idle-mode');

                    // Auto Next Logic
                    if (isLoop) {
                        video.currentTime = 0;
                        video.play();
                    } else if (isAutoplay) {
                        playNextVideo();
                    }
                });

                // Timeline & Time Update
                function formatTime(time) {
                    const m = Math.floor(time / 60);
                    const s = Math.floor(time % 60);
                    return `${m}:${s < 10 ? '0' : ''}${s}`;
                }

                video.addEventListener('timeupdate', () => {
                    const ct = video.currentTime, d = video.duration;
                    if (!isNaN(d)) {
                        const pct = (ct / d) * 100;
                        seekSlider.value = pct;
                        progressBar.style.width = `${pct}%`;
                        currentTimeElem.textContent = formatTime(ct);
                        durationElem.textContent = formatTime(d);
                    }
                });

                video.addEventListener('progress', () => {
                    if (video.buffered.length > 0)
                        bufferBar.style.width = `${(video.buffered.end(video.buffered.length - 1) / video.duration) * 100}%`;
                });

                seekSlider.addEventListener('input', (e) => {
                    video.currentTime = (video.duration / 100) * e.target.value;
                    if (isAmbientOn)
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resetIdleTimer();
                });

                video.addEventListener('loadedmetadata', () => {
                    durationElem.textContent = formatTime(video.duration);
                });

                // Volume & Buttons
                volumeSlider.addEventListener('input', (e) => {
                    video.volume = e.target.value;
                    video.muted = video.volume === 0;
                    volumeIcon.textContent = video.muted ? 'volume_off' : (video.volume < 0.5 ? 'volume_down' : 'volume_up');
                });

                muteBtn.addEventListener('click', () => {
                    video.muted = !video.muted;
                    volumeIcon.textContent = video.muted ? 'volume_off' : 'volume_up';
                    if (!video.muted && video.volume === 0) {
                        video.volume = 1;
                        volumeSlider.value = 1;
                    } else if (!video.muted)
                        volumeSlider.value = video.volume;
                    else
                        volumeSlider.value = 0;
                });

                centerPlayBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePlay();
                });
                playBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePlay();
                });

                fullscreenBtn.addEventListener('click', () => {
                    if (!document.fullscreenElement)
                        videoWrapper.requestFullscreen().catch(console.error);
                    else
                        document.exitFullscreen();
                });

                document.addEventListener('fullscreenchange', () => {
                    if (document.fullscreenElement) {
                        fullscreenBtn.querySelector('span').textContent = 'close_fullscreen';
                        videoWrapper.classList.add('bg-black', 'fullscreen-mode');
                        videoContainer.classList.remove('rounded-xl');
                    } else {
                        fullscreenBtn.querySelector('span').textContent = 'fullscreen';
                        videoWrapper.classList.remove('bg-black', 'fullscreen-mode');
                        videoContainer.classList.add('rounded-xl');
                    }
                });

                // --- 6. SETTINGS & AMBIENT LOGIC ---

                // Ambient Loop
                function loop() {
                    if (!video.paused && !video.ended && isAmbientOn) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        animationFrameId = requestAnimationFrame(loop);
                    }
                }
                function startAmbientLoop() {
                    if (!isAmbientOn)
                        return;
                    canvas.classList.remove('opacity-0');
                    canvas.classList.add('opacity-100');
                    cancelAnimationFrame(animationFrameId);
                    loop();
                }
                function stopAmbientLoop() {
                    cancelAnimationFrame(animationFrameId);
                }

                function applyAmbientState() {
                    if (isAmbientOn) {
                        ambientSwitchBg.classList.replace('bg-gray-600', 'bg-primary');
                        ambientSwitchKnob.classList.add('translate-x-5', 'bg-white');
                        ambientSwitchKnob.classList.remove('translate-x-1');
                        canvas.style.display = 'block';
                        if (!video.paused)
                            startAmbientLoop();
                    } else {
                        ambientSwitchBg.classList.replace('bg-primary', 'bg-gray-600');
                        ambientSwitchKnob.classList.remove('translate-x-5', 'bg-white');
                        ambientSwitchKnob.classList.add('translate-x-1');
                        canvas.style.display = 'none';
                        stopAmbientLoop();
                    }
                }

                // Init Settings UI
                function updateSwitchUI(isOn, bg, knob) {
                    if (isOn) {
                        bg.classList.replace('bg-gray-600', 'bg-primary');
                        knob.classList.add('translate-x-5');
                        knob.classList.remove('translate-x-1');
                    } else {
                        bg.classList.replace('bg-primary', 'bg-gray-600');
                        knob.classList.remove('translate-x-5');
                        knob.classList.add('translate-x-1');
                    }
                }

                applyAmbientState();
                updateSwitchUI(isLoop, loopSwitchBg, loopSwitchKnob);
                updateSwitchUI(isAutoplay, autoplaySwitchBg, autoplaySwitchKnob);
                seekSettingSlider.value = seekStep;
                seekSettingValue.innerText = `${seekStep}s`;

                // Settings Listeners
                toggleAmbientBtn.addEventListener('click', () => {
                    isAmbientOn = !isAmbientOn;
                    localStorage.setItem('ambientMode', isAmbientOn);
                    applyAmbientState();
                });
                toggleLoopBtn.addEventListener('click', () => {
                    isLoop = !isLoop;
                    localStorage.setItem('isLoop', isLoop);
                    updateSwitchUI(isLoop, loopSwitchBg, loopSwitchKnob);
                });
                toggleAutoplayBtn.addEventListener('click', () => {
                    isAutoplay = !isAutoplay;
                    localStorage.setItem('isAutoplay', isAutoplay);
                    updateSwitchUI(isAutoplay, autoplaySwitchBg, autoplaySwitchKnob);
                });
                seekSettingSlider.addEventListener('input', (e) => {
                    seekStep = parseInt(e.target.value);
                    seekSettingValue.innerText = `${seekStep}s`;
                    localStorage.setItem('seekStep', seekStep);
                });

                // Settings Menu Toggle
                window.openSettings = function () {
                    settingsMenu.classList.remove('invisible', 'opacity-0', 'translate-y-4');
                    settingsMenu.classList.add('opacity-100', 'translate-y-0');
                    settingsBtn.classList.add('rotate-90', 'text-primary');
                    videoWrapper.classList.remove('idle-mode');
                }
                window.closeSettings = function () {
                    settingsMenu.classList.add('invisible', 'opacity-0', 'translate-y-4');
                    settingsMenu.classList.remove('opacity-100', 'translate-y-0');
                    settingsBtn.classList.remove('rotate-90', 'text-primary');
                }
                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isHidden = settingsMenu.classList.contains('invisible');
                    if (isHidden)
                        openSettings();
                    else
                        closeSettings();
                });
                document.addEventListener('click', (e) => {
                    if (settingsMenu.contains(e.target) && e.target === settingsMenu)
                        closeSettings(); // Close on backdrop click
                    else if (!settingsMenu.contains(e.target) && e.target !== settingsBtn && !settingsMenu.classList.contains('invisible'))
                        closeSettings();
                });

                // --- 7. SIDEBAR & THEATER MODE ---

                window.openSidebar = function () {
                    rightCol.classList.remove('translate-x-full');
                    sidebarOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
                window.closeSidebar = function () {
                    rightCol.classList.add('translate-x-full');
                    sidebarOverlay.classList.add('hidden');
                    document.body.style.overflow = '';
                }

                function applyTheaterState() {
                    if (window.innerWidth < 1024)
                        return;
                    if (isTheater) {
                        leftCol.classList.remove('lg:col-span-3');
                        leftCol.classList.add('lg:col-span-4');
                        video.classList.remove('aspect-video');
                        video.classList.add('h-[80vh]');
                        theaterBtn.classList.add('text-primary');
                        videoContainer.classList.add('ring-primary/50');
                        window.scrollTo({top: 0, behavior: 'smooth'});
                    } else {
                        leftCol.classList.remove('lg:col-span-4');
                        leftCol.classList.add('lg:col-span-3');
                        video.classList.add('aspect-video');
                        video.classList.remove('h-[80vh]');
                        theaterBtn.classList.remove('text-primary');
                        videoContainer.classList.remove('ring-primary/50');
                    }
                    setTimeout(() => {
                        if (isAmbientOn && !video.paused)
                            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    }, 550);
                }
                applyTheaterState();
                theaterBtn.addEventListener('click', () => {
                    isTheater = !isTheater;
                    localStorage.setItem('isTheater', isTheater);
                    applyTheaterState();
                });
                window.addEventListener('resize', applyTheaterState); // Re-check on resize

                // --- 8. HELPER: NEXT VIDEO ---
                function playNextVideo() {
                    const items = Array.from(document.querySelectorAll('.playlist-item'));
                    const currentIndex = items.findIndex(item => item.getAttribute('data-active') === 'true');
                    if (currentIndex !== -1 && currentIndex < items.length - 1) {
                        const nextItem = items[currentIndex + 1];
                        nextItem.click();
                        return true;
                    }
                    return false;
                }

                // --- 9. IDLE TIMER ---
                function resetIdleTimer() {
                    videoWrapper.classList.remove('idle-mode');
                    clearTimeout(idleTimer);
                    if (!video.paused) {
                        idleTimer = setTimeout(() => {
                            if (!settingsMenu.classList.contains('invisible'))
                                return;
                            videoWrapper.classList.add('idle-mode');
                        }, 2500);
                    }
                }
                videoWrapper.addEventListener('mousemove', resetIdleTimer);
                videoWrapper.addEventListener('mousedown', resetIdleTimer);
                videoWrapper.addEventListener('keydown', resetIdleTimer);
                videoWrapper.addEventListener('mouseleave', () => {
                    if (!video.paused)
                        videoWrapper.classList.add('idle-mode');
                });

                // --- 10. SHORTCUTS ---
                document.addEventListener('keydown', (e) => {
                    if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName))
                        return;
                    const key = e.key.toLowerCase();
                    resetIdleTimer();
                    switch (key) {
                        case ' ':
                        case 'k':
                            e.preventDefault();
                            togglePlay();
                            break;
                        case 'arrowleft':
                        case 'a':
                            performSeek(-seekStep);
                            break;
                        case 'arrowright':
                        case 'd':
                            performSeek(seekStep);
                            break;
                        case 'f':
                            fullscreenBtn.click();
                            break;
                        case 'm':
                            muteBtn.click();
                            break;
                        case 't':
                            theaterBtn.click();
                            break;
                        case 'n':
                        case 'e':
                            playNextVideo();
                            break;
                    }
                });
            });
        </script>
    </th:block>
</body>
</html>