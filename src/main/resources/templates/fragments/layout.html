<!DOCTYPE html>
<html class="dark" lang="en" xmlns:th="http://www.thymeleaf.org" th:fragment="layout(title, activePage, content, pageScripts)">
    <head>
        <meta charset="utf-8"/>
        <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
        <meta name="_csrf" th:content="${_csrf.token}"/>
        <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
        <title th:text="${title}">MediaVault</title>

        <link href="https://fonts.googleapis.com" rel="preconnect"/>
        <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
        <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>

        <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
        <script>
            tailwind.config = {
                darkMode: "class",
                theme: {
                    extend: {
                        colors: {
                            "primary": "#833cf6",
                            "primary-dark": "#6a2bc4",
                            "background-dark": "#171022",
                            "surface": "#1e1e1e",
                        },
                        fontFamily: {"display": ["Space Grotesk", "sans-serif"]},
                    },
                },
            }
        </script>
        <style>
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: #443b54;
                border-radius: 3px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: #833cf6;
            }
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .glass-panel {
                background: rgba(23, 16, 34, 0.95);
                backdrop-filter: blur(16px);
                border-right: 1px solid rgba(255, 255, 255, 0.08);
            }
            .glass-header {
                background: rgba(23, 16, 34, 0.8);
                backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            }
        </style>
    </head>
    <body class="bg-background-dark text-white font-display overflow-hidden antialiased">

        <div id="sidebarOverlay" onclick="toggleSidebar()" 
             class="fixed inset-0 bg-black/80 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity opacity-0"
             style="transition: opacity 0.3s ease;">
        </div>

        <div class="flex h-screen w-full">

            <aside id="sidebar" class="glass-panel fixed inset-y-0 left-0 z-50 w-72 flex flex-col justify-between overflow-y-auto no-scrollbar shrink-0 transition-transform duration-300 -translate-x-full lg:translate-x-0 lg:static lg:flex">

                <button onclick="toggleSidebar()" class="absolute top-4 right-4 text-gray-400 hover:text-white lg:hidden z-50">
                    <span class="material-symbols-outlined">close</span>
                </button>

                <div class="flex flex-col p-4 gap-6 h-full overflow-hidden">
                    <div class="flex items-center gap-3 px-2">
                        <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-primary text-white">
                            <span class="material-symbols-outlined text-[20px]">cloud_circle</span>
                        </div>
                        <div>
                            <h1 class="text-white text-lg font-bold leading-none tracking-tight">MediaVault</h1>
                            <p class="text-[#a79cba] text-xs font-normal mt-0.5">v2.4.0 • Enterprise</p>
                        </div>
                    </div>

                    <a class="flex items-center justify-center gap-2 rounded-xl h-12 bg-primary hover:bg-primary-dark transition-colors font-bold shadow-lg shadow-primary/20 cursor-pointer"
                       th:if="${activePage == 'subjects'}"
                       th:href="@{/admin/scan-subjects}">
                        <span class="material-symbols-outlined text-[18px]">person_add</span>
                        <span>Scan New Subject</span>
                    </a>

                    <div class="flex flex-col gap-1 overflow-y-auto" style="flex-grow: 1">
                        <p class="px-3 text-[#a79cba] text-xs font-bold uppercase tracking-wider mb-2">Browse</p>

                        <a th:href="@{/}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'dashboard'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'dashboard'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">home</span>
                            <p class="text-sm font-medium">Home</p>
                        </a>

                        <div class="h-px bg-white/10 w-full"></div>

                        <a th:href="@{/subjects}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'subjects'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'subjects'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">group</span>
                            <p class="text-sm font-medium">People / Subjects</p>
                        </a>

                        <a th:href="@{/admin/platforms}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'platforms'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'platforms'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">public</span>
                            <p class="text-sm font-medium">Social Platforms</p>
                        </a>

                        <div class="h-px bg-white/10 w-full"></div>
                        <a th:href="@{/}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'tags'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'tags'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">Movie</span>
                            <p class="text-sm font-medium">Movie</p>
                        </a>

                        <a th:href="@{/manga}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'manga'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'manga'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">menu_book</span>
                            <p class="text-sm font-medium">Manga Library</p>
                        </a>
                        <div class="h-px bg-white/10 w-full"></div>
                        <a th:href="@{/admin/tags}" 
                           class="flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors group"
                           th:classappend="${activePage == 'tags'} ? 'bg-primary/20 text-white border border-primary/20' : 'text-[#a79cba] hover:text-white hover:bg-[#2e2839]/50'">
                            <span class="material-symbols-outlined" 
                                  th:classappend="${activePage == 'tags'} ? 'text-white' : 'text-[#a79cba] group-hover:text-white'"
                                  style="font-variation-settings: 'FILL' 1;">label</span>
                            <p class="text-sm font-medium">Tags</p>
                        </a>
                    </div>

                    <div class="flex flex-col gap-3 mt-auto mb-4">
                        <div>
                            <div class="h-px bg-white/10 w-full mb-4"></div>
                            <p class="px-3 text-[#a79cba] text-xs font-bold uppercase tracking-wider">STORAGE VOLUMNE</p>
                        </div>

                        <div class="flex items-center gap-4 px-3 border-b border-white/5 pb-2">
                            <button onclick="switchStorageTab('system')" 
                                    id="tabBtn-system"
                                    class="text-xs font-bold uppercase tracking-wider text-white transition-colors border-b-2 border-primary pb-0.5 outline-none">
                                System
                            </button>

                            <button th:if="${mappings != null}" 
                                    onclick="switchStorageTab('subject')" 
                                    id="tabBtn-subject"
                                    class="text-xs font-bold uppercase tracking-wider text-gray-500 hover:text-gray-300 transition-colors border-b-2 border-transparent pb-0.5 outline-none">
                                Subject
                            </button>
                        </div>

                        <div class="px-3 min-h-[100px] max-h-48 overflow-y-auto custom-scrollbar pr-1 relative">
                            <div id="tabContent-system" class="flex flex-col gap-4 animate-in fade-in duration-300" th:if="${not #lists.isEmpty(activeVolumes)}">
                                <div th:each="vol : ${activeVolumes}" class="flex flex-col gap-1 group">
                                    <div class="flex justify-between items-end"
                                         th:with="percent=${vol.totalCapacity > 0 ? (1.0 - (vol.availableCapacity * 1.0 / vol.totalCapacity)) * 100 : 0}">
                                        <div class="flex items-center gap-1.5 overflow-hidden">
                                            <span class="material-symbols-outlined text-gray-500 text-[14px] group-hover:text-white transition-colors">hard_drive</span>
                                            <span class="text-white text-xs font-medium truncate max-w-[100px]" th:text="${vol.label}">Volume</span>
                                        </div>
                                        <span class="text-primary text-[10px] font-bold" th:text="${#numbers.formatDecimal(percent, 0, 0) + '%'}">50%</span>
                                    </div>
                                    <div class="h-1.5 w-full rounded-full bg-[#2e2839] overflow-hidden"
                                         th:with="percent=${vol.totalCapacity > 0 ? (1.0 - (vol.availableCapacity * 1.0 / vol.totalCapacity)) * 100 : 0}">
                                        <div class="h-full rounded-full transition-all duration-1000"
                                             th:style="'width: ' + ${percent} + '%;'"
                                             th:classappend="${percent > 90 ? 'bg-red-500' : (percent > 75 ? 'bg-yellow-500' : 'bg-primary')}"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-[#a79cba]">
                                        <span th:text="${vol.mountPoint}">C:</span>
                                        <span class="size-format-free-system" th:data-free="${vol.availableCapacity}" th:data-total="${vol.totalCapacity}">...</span>
                                    </div>
                                </div>
                            </div>

                            <div id="tabContent-subject" class="hidden flex-col gap-4 animate-in fade-in duration-300" th:if="${mappings != null}">
                                <div th:if="${#lists.isEmpty(mappings)}" class="text-xs text-gray-500 italic text-center py-2">No folders mapped.</div>
                                <div th:each="map, stat : ${mappings}" 
                                     th:onclick="'if(typeof filterByFolder === \'function\') filterByFolder(' + ${map.id} + ', this)'"
                                     class="mapping-item flex flex-col gap-1 group cursor-pointer hover:bg-white/5 border border-transparent rounded-lg p-2 transition-all">
                                    <div class="flex justify-between items-center gap-2">
                                        <div class="flex items-center gap-1.5 overflow-hidden min-w-0">
                                            <span class="material-symbols-outlined text-yellow-500 text-[14px] shrink-0">folder</span>
                                            <span class="text-white text-xs font-medium truncate" th:text="${map.relativePath}" th:title="${map.volume.mountPoint + map.relativePath}">Path</span>
                                        </div>
                                        <span class="text-primary text-[10px] font-bold whitespace-nowrap size-format-simple shrink-0" th:data-size="${map.folderUsage}">0 MB</span>
                                    </div>
                                    <div class="relative h-1.5 w-full rounded-full bg-[#2e2839] overflow-hidden mt-0.5">
                                        <div class="absolute top-0 left-0 h-full bg-gray-600 rounded-full transition-all duration-1000"
                                             th:with="volPercent=${map.volume.totalCapacity > 0 ? (1.0 - (map.volume.availableCapacity * 1.0 / map.volume.totalCapacity)) * 100 : 0}"
                                             th:style="'width: ' + ${volPercent} + '%;'"></div>
                                        <div class="absolute top-0 left-0 h-full bg-primary rounded-full transition-all duration-1000 shadow-[0_0_8px_rgba(131,60,246,0.6)]"
                                             th:with="folderPercent=${map.volume.totalCapacity > 0 ? (map.folderUsage * 1.0 / map.volume.totalCapacity) * 100 : 0}"
                                             th:style="'width: ' + ${folderPercent} + '%;'"></div>
                                    </div>
                                    <div class="flex justify-between text-[10px] text-[#a79cba]">
                                        <div><span th:text="${map.volume.mountPoint}">E:\</span> <span th:text="${map.volume.label}">Vol</span></div>
                                        <span class="size-format-free" th:data-free="${map.volume.availableCapacity}">Free: ...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="flex-1 flex flex-col relative overflow-hidden bg-background-dark" th:replace="${content}">
            </main>

        </div>

        <div th:replace="${pageScripts}"></div>
        <script>
            // --- RESPONSIVE SIDEBAR LOGIC ---
            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');

                if (sidebar.classList.contains('-translate-x-full')) {
                    // Open
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                    // Timeout nhỏ để kích hoạt transition opacity
                    setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                } else {
                    // Close
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('opacity-0');
                    setTimeout(() => overlay.classList.add('hidden'), 300);
                }
            }

            // --- TAB LOGIC ---
            function switchStorageTab(tabName) {
                document.querySelectorAll('[id^="tabContent-"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('[id^="tabBtn-"]').forEach(el => {
                    el.className = "text-xs font-bold uppercase tracking-wider text-gray-500 hover:text-gray-300 transition-colors border-b-2 border-transparent pb-0.5 outline-none";
                });

                const content = document.getElementById('tabContent-' + tabName);
                if (content)
                    content.classList.remove('hidden');

                const btn = document.getElementById('tabBtn-' + tabName);
                if (btn) {
                    btn.className = "text-xs font-bold uppercase tracking-wider text-white transition-colors border-b-2 border-primary pb-0.5 outline-none";
                }
            }

            // --- FORMAT UTILS ---
            function formatBytes(bytes, decimals = 1) {
                if (!+bytes)
                    return '0 B';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
            }

            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll('.size-format-free-system').forEach(el => {
                    const free = el.getAttribute('data-free');
                    const total = el.getAttribute('data-total');
                    if (free && total)
                        el.innerText = `Free: ${formatBytes(free)} / ${formatBytes(total)}`;
                });
                document.querySelectorAll('.size-format-free').forEach(el => {
                    const free = el.getAttribute('data-free');
                    if (free)
                        el.innerText = `Free: ${formatBytes(free)}`;
                });
                document.querySelectorAll('.size-format-simple').forEach(el => {
                    const size = el.getAttribute('data-size');
                    if (size)
                        el.innerText = formatBytes(size);
                });

                // Auto switch tab
                const subjectTabBtn = document.getElementById('tabBtn-subject');
                if (subjectTabBtn) {
                    switchStorageTab('subject');
                } else {
                    switchStorageTab('system');
                }
            });
        </script>
    </body>
</html>