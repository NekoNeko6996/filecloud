<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Tags Management', 'tags', ~{::section}, ~{::script})}">
    <body>

        <section class="flex-1 flex flex-col relative overflow-hidden bg-background-dark">
            <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <h2 class="text-xl font-bold text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-pink-400">label</span> Tags
                </h2>
                <button onclick="openCreateModal()" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined text-[18px]">add</span> New Tag
                </button>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth" onclick="closeContextMenu()">

                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                    <div th:each="t : ${tags}" 
                         class="group relative bg-[#2e2839] border border-white/5 rounded-xl p-4 cursor-pointer hover:border-primary/50 hover:bg-[#362f42] transition-all shadow-lg hover:shadow-primary/10"
                         th:data-id="${t.id}"
                         th:data-name="${t.name}"
                         th:data-slug="${t.slug}"
                         th:data-color="${t.colorHex}"
                         th:data-desc="${t.description}"
                         oncontextmenu="openContextMenu(event, this)">

                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-4 h-4 rounded-full shadow-inner" 
                                 th:style="'background-color: ' + (${t.colorHex} ?: '#833cf6')"></div>
                            <h3 class="text-white font-bold truncate flex-1" th:text="${t.name}">Name</h3>
                        </div>

                        <p class="text-[#a79cba] text-xs font-mono bg-black/20 rounded px-2 py-1 truncate inline-block w-full" th:text="'#' + ${t.slug}">slug</p>
                        <p class="text-gray-500 text-[10px] mt-2 line-clamp-2" th:text="${t.description} ?: 'No description'">Desc</p>
                    </div>
                </div>

                <div th:if="${tags.isEmpty()}" class="flex flex-col items-center justify-center h-64 text-gray-500">
                    <span class="material-symbols-outlined text-5xl mb-2">label_off</span>
                    <p>No tags defined.</p>
                </div>
            </div>

            <div id="contextMenu" class="hidden fixed z-50 w-48 bg-[#1e1e1e] border border-white/10 rounded-lg shadow-xl overflow-hidden py-1">
                <button onclick="viewDetails()" class="w-full text-left px-4 py-2.5 text-sm text-gray-200 hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">info</span> Details
                </button>
                <button onclick="editTag()" class="w-full text-left px-4 py-2.5 text-sm text-gray-200 hover:bg-primary hover:text-white flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">edit</span> Edit
                </button>
                <div class="h-px bg-white/10 my-1 mx-2"></div>
                <button onclick="deleteTag()" class="w-full text-left px-4 py-2.5 text-sm text-red-400 hover:bg-red-500/10 hover:text-red-300 flex items-center gap-2 transition-colors">
                    <span class="material-symbols-outlined text-[18px]">delete</span> Delete
                </button>
            </div>

            <aside id="detailsPanel" class="glass-panel fixed right-0 top-0 h-screen w-96 flex flex-col border-l border-white/10 bg-[#171022] shadow-2xl translate-x-full transition-transform duration-300 ease-in-out z-40">
                <div class="p-6 flex flex-col h-full">
                    <div class="flex items-center justify-between mb-6 shrink-0">
                        <h3 class="text-white font-bold text-lg flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">label</span> Tag Details
                        </h3>
                        <button onclick="closeDetails()" class="text-[#a79cba] hover:text-white transition-colors"><span class="material-symbols-outlined">close</span></button>
                    </div>

                    <div class="flex items-start gap-4 mb-6 shrink-0">
                        <div id="detailColor" class="w-12 h-12 rounded-lg shadow-lg border border-white/10"></div>
                        <div>
                            <h2 id="detailName" class="text-2xl font-bold text-white">Name</h2>
                            <p id="detailSlug" class="text-primary text-sm font-mono mt-1">#slug</p>
                        </div>
                    </div>

                    <p id="detailDesc" class="text-gray-400 text-sm mb-6 shrink-0 italic border-l-2 border-white/10 pl-3">Description</p>

                    <div class="h-px bg-white/10 w-full mb-4 shrink-0"></div>

                    <div class="flex-1 overflow-hidden flex flex-col">
                        <h4 class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-3">Tagged Media (<span id="countFiles">0</span>)</h4>
                        <div class="flex-1 overflow-y-auto space-y-2 pr-2" id="linkedFilesList">
                        </div>
                    </div>
                </div>
            </aside>

            <dialog id="tagModal" class="bg-[#1e1e1e] text-white p-6 rounded-xl border border-gray-700 shadow-2xl backdrop:bg-black/80 w-full max-w-md">
                <form th:action="@{/admin/tags/save}" method="post" class="flex flex-col gap-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-xl" id="modalTitle">Create Tag</h3>
                        <button type="button" onclick="this.closest('dialog').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>

                    <input type="hidden" name="id" id="inputId">

                    <div class="grid grid-cols-4 gap-4">
                        <div class="col-span-3">
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Name</label>
                            <input type="text" name="name" id="inputName" required placeholder="e.g. Landscape"
                                   class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Color</label>
                            <input type="color" name="colorHex" id="inputColor" value="#833cf6"
                                   class="w-full h-[42px] bg-black/30 border border-white/10 rounded cursor-pointer p-1">
                        </div>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Slug (Optional)</label>
                        <input type="text" name="slug" id="inputSlug" placeholder="Auto-generated if empty"
                               class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary font-mono text-sm">
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 mb-1 block uppercase font-bold tracking-wide">Description</label>
                        <textarea name="description" id="inputDesc" rows="3" placeholder="Description..."
                                  class="w-full bg-black/30 border border-white/10 rounded px-4 py-2 text-white focus:outline-none focus:border-primary"></textarea>
                    </div>

                    <div class="flex gap-3 justify-end mt-4 pt-4 border-t border-white/5">
                        <button type="button" onclick="this.closest('dialog').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white font-medium">Cancel</button>
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-primary/20">Save</button>
                    </div>
                </form>
            </dialog>

            <form id="deleteForm" th:action="@{/admin/tags/delete}" method="post" class="hidden">
                <input type="hidden" name="id" id="deleteId">
            </form>

        </section>

        <script>
            // --- CONTEXT MENU ---
            const contextMenu = document.getElementById('contextMenu');
            let activeItem = null;

            function openContextMenu(e, el) {
                e.preventDefault();
                e.stopPropagation();

                activeItem = {
                    id: el.getAttribute('data-id'),
                    name: el.getAttribute('data-name'),
                    slug: el.getAttribute('data-slug'),
                    color: el.getAttribute('data-color'),
                    desc: el.getAttribute('data-desc')
                };

                let x = e.clientX;
                let y = e.clientY;
                if (window.innerWidth - x < 200)
                    x -= 200;
                if (window.innerHeight - y < 150)
                    y -= 150;

                contextMenu.style.left = `${x}px`;
                contextMenu.style.top = `${y}px`;
                contextMenu.classList.remove('hidden');
            }

            function closeContextMenu() {
                contextMenu.classList.add('hidden');
            }

            // --- DETAILS SIDE PANEL ---
            const detailsPanel = document.getElementById('detailsPanel');

            function closeDetails() {
                detailsPanel.classList.remove('translate-x-0');
                detailsPanel.classList.add('translate-x-full');
            }

            function viewDetails() {
                closeContextMenu();
                if (!activeItem)
                    return;

                detailsPanel.classList.remove('translate-x-full');
                detailsPanel.classList.add('translate-x-0');

                document.getElementById('detailName').innerText = activeItem.name;
                document.getElementById('detailSlug').innerText = '#' + activeItem.slug;
                document.getElementById('detailColor').style.backgroundColor = activeItem.color || '#833cf6';
                document.getElementById('detailDesc').innerText = activeItem.desc || 'No description';

                const list = document.getElementById('linkedFilesList');
                list.innerHTML = '<p class="text-gray-500 text-sm animate-pulse">Loading tagged media...</p>';

                // Fetch linked files
                fetch(`/admin/tags/${activeItem.id}/details`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('countFiles').innerText = data.files.length;

                            if (data.files.length === 0) {
                                list.innerHTML = '<p class="text-gray-500 text-sm italic">No media found with this tag.</p>';
                                return;
                            }

                            list.innerHTML = data.files.map(f => `
                            <div class="flex items-center justify-between p-2 bg-white/5 rounded-lg border border-white/5 hover:border-primary/30 group transition-colors">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="material-symbols-outlined text-gray-400 text-sm">${f.isVideo ? 'movie' : 'image'}</span>
                                    <span class="text-white text-sm font-medium truncate">${f.name}</span>
                                </div>
                            </div>
                        `).join('');
                        })
                        .catch(err => {
                            console.error(err);
                            list.innerHTML = '<p class="text-red-400 text-sm">Error loading data.</p>';
                        });
            }

            // --- CREATE / EDIT MODAL ---
            function openCreateModal() {
                document.getElementById('modalTitle').innerText = 'Create Tag';
                document.getElementById('inputId').value = '';
                document.getElementById('inputName').value = '';
                document.getElementById('inputSlug').value = '';
                document.getElementById('inputColor').value = '#833cf6';
                document.getElementById('inputDesc').value = '';

                document.getElementById('tagModal').showModal();
            }

            function editTag() {
                closeContextMenu();
                if (!activeItem)
                    return;

                document.getElementById('modalTitle').innerText = 'Edit Tag';
                document.getElementById('inputId').value = activeItem.id;
                document.getElementById('inputName').value = activeItem.name;
                document.getElementById('inputSlug').value = activeItem.slug;
                document.getElementById('inputColor').value = activeItem.color || '#833cf6';
                document.getElementById('inputDesc').value = activeItem.desc || '';

                document.getElementById('tagModal').showModal();
            }

            // --- DELETE ---
            function deleteTag() {
                closeContextMenu();
                if (!activeItem)
                    return;
                if (confirm(`Delete tag #${activeItem.slug}? This will remove it from all associated files.`)) {
                    document.getElementById('deleteId').value = activeItem.id;
                    document.getElementById('deleteForm').submit();
                }
            }
        </script>

    </body>
</html>