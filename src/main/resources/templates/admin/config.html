<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('System Configuration', 'config', ~{::section}, ~{::script})}">
    <body>

        <section class="flex-1 flex flex-col relative overflow-hidden bg-background-dark">
            <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-white transition-colors">
                        <span class="material-symbols-outlined text-2xl">menu</span>
                    </button>
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">settings</span> System Configuration
                    </h2>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
                <div class="max-w-4xl mx-auto space-y-8">

                    <div th:if="${success}" class="p-4 rounded-lg bg-green-500/10 border border-green-500/20 text-green-400 flex items-center gap-3">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span th:text="${success}">Success message</span>
                    </div>
                    <div th:if="${error}" class="p-4 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 flex items-center gap-3">
                        <span class="material-symbols-outlined">error</span>
                        <span th:text="${error}">Error message</span>
                    </div>

                    <div class="bg-[#1e1e1e] border border-white/5 rounded-2xl p-6 shadow-xl">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-white mb-1">Movie Module Settings</h3>
                                <p class="text-sm text-gray-400">Configure where your movie files are physically stored.</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold border"
                                  th:classappend="${pathStatus == 'ACTIVE' ? 'bg-green-500/10 border-green-500/30 text-green-400' : 
                                  (pathStatus == 'NOT_CONFIGURED' ? 'bg-gray-500/10 border-gray-500/30 text-gray-400' : 'bg-red-500/10 border-red-500/30 text-red-400')}"
                                  th:text="${pathStatus}">STATUS</span>
                        </div>

                        <form action="/admin/config/save-movie-path" method="post" class="space-y-4">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Physical Main Path</label>
                                <div class="relative group">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 group-focus-within:text-primary transition-colors">folder_open</span>
                                    <input type="text" name="path" 
                                           th:value="${moviePath}"
                                           placeholder="E:\data\movie_data" 
                                           class="w-full bg-[#171022] border border-white/10 rounded-xl pl-10 pr-4 py-3 text-white focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all font-mono text-sm">
                                </div>
                                <p class="text-xs text-gray-500 mt-2 flex items-start gap-1">
                                    <span class="material-symbols-outlined text-[14px] shrink-0 mt-0.5">info</span>
                                    <span>
                                        System will automatically detect the <strong>Storage Volume</strong> containing this path. 
                                        Even if the drive letter changes (e.g., E: → F:), the system will maintain the connection using the Drive's UUID.
                                    </span>
                                </p>
                            </div>

                            <div class="flex justify-end pt-2">
                                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-primary/20">
                                    <span class="material-symbols-outlined text-[20px]">save</span> Save Configuration
                                </button>
                            </div>
                        </form>
                    </div>

                </div>
            </div>

            <div class="bg-surface-dark border border-white/5 rounded-2xl p-6 sm:p-8 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-[80px] -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>

                <div class="flex items-center gap-3 mb-6 relative z-10">
                    <div class="size-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                        <span class="material-symbols-outlined text-blue-400">build</span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Maintenance Actions</h3>
                        <p class="text-sm text-gray-400">Run system maintenance tasks manually.</p>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 p-4 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 transition-colors">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-gray-400 mt-1">fingerprint</span>
                        <div>
                            <h4 class="text-white font-bold text-sm">Fix Missing File Hashes</h4>
                            <p class="text-xs text-gray-400 mt-1">
                                Scan database for files with missing or empty Hash strings, calculate <strong>QuickHash</strong>, and update them.
                                <br><span class="text-yellow-500/80 italic">Note: This process may take time depending on disk speed.</span>
                            </p>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <button type="button" onclick="scanMissingHashes()" 
                                class="w-full sm:w-auto px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-500/20 whitespace-nowrap">
                            <span class="material-symbols-outlined text-[18px]">search_check</span>
                            Scan Missing Hashes
                        </button>
                    </div>

                    <form id="fixHashForm" th:action="@{/admin/config/actions/fix-hashes}" method="post" class="hidden"></form>
                </div>
            </div>

            <div id="hashModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity opacity-0" id="hashModalBackdrop"></div>

                <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">

                        <div class="relative transform overflow-hidden rounded-2xl bg-[#1e1e1e] border border-white/10 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-2xl opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="hashModalPanel">

                            <div class="bg-white/5 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-white/5">
                                <h3 class="text-lg font-bold leading-6 text-white flex items-center gap-2" id="modal-title">
                                    <span class="material-symbols-outlined text-yellow-500">warning</span>
                                    Files Missing Hash
                                </h3>
                                <button onclick="closeHashModal()" class="text-gray-400 hover:text-white transition-colors">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>

                            <div class="px-4 py-4 sm:p-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                <div id="scanLoading" class="flex flex-col items-center justify-center py-8">
                                    <span class="material-symbols-outlined animate-spin text-4xl text-primary mb-2">progress_activity</span>
                                    <p class="text-gray-400 text-sm">Scanning database...</p>
                                </div>

                                <div id="scanResult" class="hidden">
                                    <p class="text-sm text-gray-300 mb-4">
                                        Found <strong id="missingCount" class="text-primary text-lg">0</strong> files without hash signature.
                                    </p>

                                    <div class="grid grid-cols-12 gap-4 text-xs font-bold text-gray-500 uppercase border-b border-white/10 pb-2 mb-2 px-2">
                                        <div class="col-span-8">File Name / Path</div>
                                        <div class="col-span-4 text-right">Size</div>
                                    </div>

                                    <div id="fileListContainer" class="space-y-1">
                                    </div>
                                </div>

                                <div id="scanEmpty" class="hidden flex flex-col items-center justify-center py-8 text-green-500">
                                    <span class="material-symbols-outlined text-4xl mb-2">check_circle</span>
                                    <p class="text-sm">All files are hashed correctly!</p>
                                </div>
                            </div>

                            <div class="bg-black/20 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2 border-t border-white/5">
                                <button id="btnCalculate" type="button" onclick="submitFixHash()" disabled
                                        class="inline-flex w-full justify-center rounded-lg bg-primary px-3 py-2 text-sm font-bold text-white shadow-sm hover:bg-primary-hover sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed items-center gap-2">
                                    <span class="material-symbols-outlined text-[18px]">calculate</span> Calculate Now
                                </button>
                                <button type="button" onclick="closeHashModal()" 
                                        class="mt-3 inline-flex w-full justify-center rounded-lg bg-white/5 px-3 py-2 text-sm font-bold text-gray-300 shadow-sm ring-1 ring-inset ring-white/10 hover:bg-white/10 sm:mt-0 sm:w-auto">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <script th:inline="javascript">
            // --- HASH SCANNER LOGIC ---
            const modal = document.getElementById('hashModal');
            const backdrop = document.getElementById('hashModalBackdrop');
            const panel = document.getElementById('hashModalPanel');
            const fileListContainer = document.getElementById('fileListContainer');
            const btnCalculate = document.getElementById('btnCalculate');

            function openHashModal() {
                modal.classList.remove('hidden');
                // Animation in
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    panel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                    panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
                }, 10);
            }

            function closeHashModal() {
                // Animation out
                backdrop.classList.add('opacity-0');
                panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
                panel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Reset UI
                    document.getElementById('scanLoading').classList.remove('hidden');
                    document.getElementById('scanResult').classList.add('hidden');
                    document.getElementById('scanEmpty').classList.add('hidden');
                    fileListContainer.innerHTML = '';
                }, 300);
            }

            function formatBytes(bytes, decimals = 2) {
                if (!+bytes)
                    return '0 Bytes';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
            }

            function scanMissingHashes() {
                openHashModal();
                btnCalculate.disabled = true;

                fetch('/admin/config/api/missing-hashes')
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('scanLoading').classList.add('hidden');

                            if (data.length === 0) {
                                document.getElementById('scanEmpty').classList.remove('hidden');
                                btnCalculate.disabled = true;
                            } else {
                                document.getElementById('scanResult').classList.remove('hidden');
                                document.getElementById('missingCount').innerText = data.length;
                                btnCalculate.disabled = false;

                                // Render List
                                let html = '';
                                // Giới hạn hiển thị 100 file đầu tiên để đỡ lag nếu list quá dài
                                const displayLimit = 100;
                                data.slice(0, displayLimit).forEach(file => {
                                    html += `
                                            <div class="grid grid-cols-12 gap-4 p-2 rounded hover:bg-white/5 border-b border-white/5 text-sm transition-colors">
                                                <div class="col-span-8 flex flex-col min-w-0">
                                                    <span class="text-white font-medium truncate" title="${file.name}">${file.name}</span>
                                                    <span class="text-xs text-gray-500 truncate" title="${file.path}">${file.path}</span>
                                                </div>
                                                <div class="col-span-4 text-right text-gray-400 font-mono text-xs flex items-center justify-end">
                                                    ${formatBytes(file.size)}
                                                </div>
                                            </div>
                                        `;
                                });

                                if (data.length > displayLimit) {
                                    html += `
                                            <div class="p-2 text-center text-xs text-gray-500 italic">
                                                ...and ${data.length - displayLimit} more files.
                                            </div>
                                        `;
                                }

                                fileListContainer.innerHTML = html;
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert("Failed to scan: " + err);
                            closeHashModal();
                        });
            }

            function submitFixHash() {
                // Hiển thị trạng thái đang xử lý trên nút
                btnCalculate.disabled = true;
                btnCalculate.innerHTML = '<span class="material-symbols-outlined animate-spin text-[18px]">progress_activity</span> Processing...';

                // Submit form thật
                document.getElementById('fixHashForm').submit();
            }
        </script>
        <script th:inline="javascript">
            function showLoading(form) {
                const btn = form.querySelector('button');
                const originalContent = btn.innerHTML;

                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
                btn.innerHTML = `
                    <span class="material-symbols-outlined animate-spin text-[18px]">progress_activity</span>
                    Processing...
                `;

                // Form sẽ tự submit sau đó
            }
        </script>
    </body>
</html>