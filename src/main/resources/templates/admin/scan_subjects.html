<!DOCTYPE html>
<html class="dark" lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Scan Subjects', 'settings', ~{::section}, ~{::script})}">
    <body>
        <section class="flex-1 flex flex-col relative overflow-y-auto bg-background-dark scroll-smooth">
            <header class="glass-header h-16 flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <a th:href="@{/subjects}">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span class="material-symbols-outlined">keyboard_backspace</span> Return to Subject
                    </h2>
                </a>
            </header>

            <div class="max-w-6xl mx-auto w-full p-8">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-white mb-2">Subject Media Scanner</h1>
                    <p class="text-gray-400">Scan physical folders (e.g. [Name][Alias]) and map them to Subjects.</p>
                </div>

                <div class="bg-[#2e2839] p-6 rounded-xl border border-white/5 mb-8">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Root Directory Path</label>
                    <div class="flex gap-4">
                        <input type="text" id="rootPath" value="F:/TESTFOLDER" 
                               class="flex-1 bg-[#1e1926] border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primary font-mono"
                               placeholder="E.g: F:/VIDEO">
                        <button onclick="scanPreview()" class="bg-primary hover:bg-primary-dark text-white px-6 py-3 rounded-lg font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined">search</span> Scan
                        </button>
                    </div>
                </div>

                <div id="resultArea" class="hidden">
                    <div class="flex justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-4 flex-1">
                            <h3 class="text-lg font-bold text-white shrink-0">Found <span id="countFound" class="text-primary">0</span> folders</h3>

                            <div class="relative w-full max-w-sm">
                                <span class="material-symbols-outlined absolute left-3 top-2.5 text-gray-500 text-sm">search</span>
                                <input type="text" id="searchInput" oninput="handleSearch()" 
                                       class="w-full bg-[#1e1926] border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white focus:outline-none focus:border-primary placeholder-gray-600"
                                       placeholder="Filter by name, alias...">
                            </div>
                        </div>

                        <button onclick="executeImport()" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 shrink-0">
                            <span class="material-symbols-outlined">save_alt</span> Import Selected
                        </button>
                    </div>

                    <div class="bg-[#2e2839] rounded-xl border border-white/5 overflow-hidden">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="bg-[#1e1926] text-xs uppercase font-bold text-gray-400 select-none">
                                <tr>
                                    <th class="px-6 py-4 w-10">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleAll(this)" class="rounded bg-gray-700 border-gray-600 text-primary focus:ring-0">
                                    </th>
                                    <th class="px-6 py-4 cursor-pointer hover:text-white transition-colors group" onclick="handleSort('existsInDb')">
                                        <div class="flex items-center gap-1">
                                            Status <span id="sortIcon_existsInDb" class="material-symbols-outlined text-[16px] opacity-0 group-hover:opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-4 cursor-pointer hover:text-white transition-colors group" onclick="handleSort('folderName')">
                                        <div class="flex items-center gap-1">
                                            Folder Name <span id="sortIcon_folderName" class="material-symbols-outlined text-[16px] opacity-0 group-hover:opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-4 cursor-pointer hover:text-white transition-colors group" onclick="handleSort('parsedMainName')">
                                        <div class="flex items-center gap-1">
                                            Parsed Name <span id="sortIcon_parsedMainName" class="material-symbols-outlined text-[16px] opacity-0 group-hover:opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-4 text-center cursor-pointer hover:text-white transition-colors group" onclick="handleSort('mediaCount')">
                                        <div class="flex items-center gap-1 justify-center">
                                            Media Files <span id="sortIcon_mediaCount" class="material-symbols-outlined text-[16px] opacity-0 group-hover:opacity-50">unfold_more</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="scanTableBody" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <dialog id="duplicateModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-5xl h-[80vh] bg-transparent">
                <div class="flex flex-col w-full h-full bg-[#1e1e1e] text-white rounded-xl border border-gray-700 overflow-hidden">
                    <div class="p-6 border-b border-white/10 flex justify-between items-center shrink-0">
                        <div>
                            <h3 class="font-bold text-xl text-yellow-500 flex items-center gap-2">
                                <span class="material-symbols-outlined">warning</span> Duplicate Files Detected
                            </h3>
                            <p class="text-sm text-gray-400 mt-1">Please resolve conflicts before importing.</p>
                        </div>
                        <button type="button" onclick="document.getElementById('duplicateModal').close()" class="text-gray-400 hover:text-white">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-8" id="duplicateContent"></div>
                    <div class="p-6 border-t border-white/10 flex justify-end gap-3 bg-[#171022] shrink-0">
                        <button onclick="document.getElementById('duplicateModal').close()" class="px-4 py-2 text-sm text-gray-400 hover:text-white">Cancel Import</button>
                        <button onclick="confirmResolvedImport()" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-lg font-bold shadow-lg">Confirm & Import</button>
                    </div>
                </div>
            </dialog>

            <dialog id="checkingModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-sm bg-transparent">
                <div class="flex flex-col w-full bg-[#1e1e1e] text-white rounded-xl border border-gray-700 p-6 items-center text-center gap-4">
                    <div class="relative w-16 h-16">
                        <div class="absolute inset-0 rounded-full border-4 border-white/10"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-primary border-t-transparent animate-spin"></div>
                        <span class="material-symbols-outlined absolute inset-0 flex items-center justify-center text-2xl text-primary">search_check</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl">Checking Duplicates...</h3>
                        <p class="text-sm text-gray-400 mt-1">Analyzing file hashes and metadata.</p>
                    </div>
                </div>
            </dialog>

            <dialog id="progressModal" class="p-0 rounded-xl shadow-2xl backdrop:bg-black/80 w-full max-w-lg bg-transparent">
                <div class="flex flex-col w-full bg-[#1e1e1e] text-white rounded-xl border border-gray-700 overflow-hidden p-6 gap-4">
                    <h3 class="font-bold text-xl flex items-center gap-2">
                        <span class="material-symbols-outlined animate-spin text-primary">sync</span> 
                        Processing Media...
                    </h3>
                    <div class="bg-[#2e2839] p-4 rounded-lg border border-white/5 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Subject:</span>
                            <span class="font-bold text-primary" id="progSubject">Waiting...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">File:</span>
                            <span class="text-white truncate max-w-[200px]" id="progFile">...</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-400">Status:</span>
                            <span class="text-yellow-400 font-mono" id="progStatus">Initializing</span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mt-2 border-t border-white/5 pt-2">
                            <span>Progress</span>
                            <span id="progCount">0 / 0</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden relative">
                        <div id="progBar" class="bg-primary h-full transition-all duration-300 ease-out" style="width: 0%"></div>
                        <span id="progPercent" class="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-white drop-shadow">0%</span>
                    </div>
                </div>
            </dialog>
        </section>

        <script>
            let scanResults = [];
            let currentPathsToImport = [];
            let duplicateGroups = [];
            let eventSource = null;

            let sortConfig = {key: null, direction: 'asc'}; // 'asc' or 'desc'
            let currentFilterData = []; // Dữ liệu đang hiển thị trên bảng (đã lọc/sort)

            // --- SCAN PREVIEW ---
            async function scanPreview() {
                const path = document.getElementById('rootPath').value;
                const btn = document.querySelector('button[onclick="scanPreview()"]');
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                btn.innerHTML = '<span class="material-symbols-outlined animate-spin">sync</span> Scanning...';

                try {
                    const res = await fetch('/admin/scan-subjects/preview', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', [csrfHeader]: csrfToken},
                        body: JSON.stringify({path: path})
                    });

                    if (res.ok) {
                        const rawData = await res.json();
                        // Lưu data gốc
                        scanResults = rawData.map((item, index) => ({
                                ...item,
                                originalIndex: index,
                                // Tạo chuỗi search trước để tìm kiếm nhanh hơn (tránh toLowerCase nhiều lần)
                                _searchText: (item.folderName + ' ' + item.parsedMainName + ' ' + (item.parsedAliases || []).join(' ')).toLowerCase()
                            }));

                        // Reset UI
                        document.getElementById('searchInput').value = '';
                        document.getElementById('selectAllCheckbox').checked = false;
                        sortConfig = {key: null, direction: 'asc'};
                        resetSortIcons();

                        // Render toàn bộ 1 lần duy nhất
                        renderFullTable(scanResults);

                        document.getElementById('resultArea').classList.remove('hidden');
                    } else {
                        alert("Error scanning directory");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Connection error");
                } finally {
                    btn.innerHTML = '<span class="material-symbols-outlined">search</span> Scan';
                }
            }

            function renderFullTable(data) {
                const tbody = document.getElementById('scanTableBody');
                tbody.innerHTML = ''; // Clear cũ
                document.getElementById('countFound').innerText = data.length;

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No folders match your search.</td></tr>';
                    return;
                }

                // Dùng DocumentFragment để append 1 lần vào DOM -> Hiệu năng cao
                const fragment = document.createDocumentFragment();

                data.forEach((item) => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors border-b border-white/5 last:border-0 group-row";
                    tr.id = `row-${item.originalIndex}`; // Đánh ID để dễ tìm
                    tr.dataset.index = item.originalIndex; // Lưu index vào dataset

                    const statusBadge = item.existsInDb
                            ? '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs border border-yellow-500/30">Update</span>'
                            : '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs border border-green-500/30">New</span>';

                    tr.innerHTML = `
                        <td class="px-6 py-4">
                            <input type="checkbox" value="${item.originalIndex}" class="item-check rounded bg-gray-700 border-gray-600 text-primary focus:ring-0">
                        </td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 font-mono text-white text-sm truncate max-w-[200px]" title="${item.folderName}">${item.folderName}</td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-white">${item.parsedMainName}</div>
                            <div class="text-xs text-gray-500">${item.parsedAliases.join(', ')}</div>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-xs font-bold border border-blue-500/30">${item.mediaCount}</span>
                        </td>
                    `;
                    fragment.appendChild(tr);
                });

                tbody.appendChild(fragment);
            }

            function handleSearch() {
                const term = document.getElementById('searchInput').value.toLowerCase().trim();
                const rows = document.querySelectorAll('#scanTableBody tr.group-row');
                let visibleCount = 0;

                // Loop qua DOM thật thay vì loop qua Data
                rows.forEach(row => {
                    const index = row.dataset.index;
                    const item = scanResults[index]; // Lấy data tương ứng

                    // Kiểm tra điều kiện tìm kiếm
                    const isMatch = !term || item._searchText.includes(term);

                    if (isMatch) {
                        row.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        row.classList.add('hidden');
                    }
                });

                document.getElementById('countFound').innerText = visibleCount;

                // Reset select all nếu đang check
                const selectAll = document.getElementById('selectAllCheckbox');
                if (selectAll.checked)
                    selectAll.checked = false;
            }

            function handleSort(key) {
                // Logic đổi hướng sort
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'asc';
                }
                updateSortIcons(key, sortConfig.direction);

                // 1. Sort mảng dữ liệu gốc
                scanResults.sort((a, b) => {
                    let valA = a[sortConfig.key];
                    let valB = b[sortConfig.key];
                    if (typeof valA === 'string')
                        valA = valA.toLowerCase();
                    if (typeof valB === 'string')
                        valB = valB.toLowerCase();

                    if (valA < valB)
                        return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB)
                        return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });

                // 2. Sắp xếp lại DOM (Re-append)
                // appendChild một node đang tồn tại sẽ tự động di chuyển nó (move) chứ không tạo mới
                const tbody = document.getElementById('scanTableBody');
                const fragment = document.createDocumentFragment();

                scanResults.forEach(item => {
                    const row = document.getElementById(`row-${item.originalIndex}`);
                    if (row) {
                        fragment.appendChild(row);
                    }
                });

                tbody.appendChild(fragment);
            }

            function toggleAll(source) {
                // Chỉ chọn những dòng không bị ẩn (class hidden)
                const visibleCheckboxes = document.querySelectorAll('#scanTableBody tr:not(.hidden) .item-check');
                visibleCheckboxes.forEach(cb => cb.checked = source.checked);
            }

            // --- HELPER: SORT ICONS ---
            function updateSortIcons(activeKey, direction) {
                resetSortIcons();
                const icon = document.getElementById(`sortIcon_${activeKey}`);
                if (icon) {
                    icon.innerText = direction === 'asc' ? 'arrow_upward' : 'arrow_downward';
                    icon.classList.remove('opacity-0', 'group-hover:opacity-50');
                    icon.classList.add('opacity-100', 'text-primary');
                }
            }

            function resetSortIcons() {
                const icons = document.querySelectorAll('[id^="sortIcon_"]');
                icons.forEach(icon => {
                    icon.innerText = 'unfold_more';
                    icon.classList.add('opacity-0', 'group-hover:opacity-50');
                    icon.classList.remove('opacity-100', 'text-primary');
                });
            }

            // --- HÀM FILTER & SORT LOGIC (MỚI) ---
            function applyTableFilters() {
                const term = document.getElementById('searchInput').value.toLowerCase();

                // 1. Filter
                let filtered = scanResults.filter(item => {
                    return item.folderName.toLowerCase().includes(term) ||
                            item.parsedMainName.toLowerCase().includes(term) ||
                            (item.parsedAliases && item.parsedAliases.some(a => a.toLowerCase().includes(term)));
                });

                // 2. Sort
                if (sortConfig.key) {
                    filtered.sort((a, b) => {
                        let valA = a[sortConfig.key];
                        let valB = b[sortConfig.key];

                        // Xử lý chuỗi để sort chính xác
                        if (typeof valA === 'string')
                            valA = valA.toLowerCase();
                        if (typeof valB === 'string')
                            valB = valB.toLowerCase();

                        if (valA < valB)
                            return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB)
                            return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                currentFilterData = filtered; // Lưu lại để dùng cho render
                renderTable(filtered);
            }

            function handleSort(key) {
                // Đổi hướng nếu click vào cùng 1 cột, ngược lại reset về asc
                if (sortConfig.key === key) {
                    sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    sortConfig.key = key;
                    sortConfig.direction = 'asc';
                }

                updateSortIcons(key, sortConfig.direction);
                applyTableFilters();
            }

            function updateSortIcons(activeKey, direction) {
                resetSortIcons();
                const icon = document.getElementById(`sortIcon_${activeKey}`);
                if (icon) {
                    icon.innerText = direction === 'asc' ? 'arrow_upward' : 'arrow_downward'; // Hoặc 'north' / 'south'
                    icon.classList.remove('opacity-0', 'group-hover:opacity-50');
                    icon.classList.add('opacity-100', 'text-primary');
                }
            }

            function resetSortIcons() {
                const icons = document.querySelectorAll('[id^="sortIcon_"]');
                icons.forEach(icon => {
                    icon.innerText = 'unfold_more';
                    icon.classList.add('opacity-0', 'group-hover:opacity-50');
                    icon.classList.remove('opacity-100', 'text-primary');
                });
            }

            function renderTable(data) {
                const tbody = document.getElementById('scanTableBody');
                document.getElementById('countFound').innerText = data.length;
                tbody.innerHTML = '';

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No folders match your search.</td></tr>';
                    return;
                }

                data.forEach((item) => {
                    const statusBadge = item.existsInDb
                            ? '<span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 rounded text-xs border border-yellow-500/30">Update</span>'
                            : '<span class="px-2 py-1 bg-green-500/20 text-green-400 rounded text-xs border border-green-500/30">New</span>';

                    // QUAN TRỌNG: value checkbox là originalIndex
                    const row = `
                        <tr class="hover:bg-white/5 transition-colors border-b border-white/5 last:border-0">
                            <td class="px-6 py-4">
                                <input type="checkbox" value="${item.originalIndex}" class="item-check rounded bg-gray-700 border-gray-600 text-primary focus:ring-0">
                            </td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 font-mono text-white text-sm truncate max-w-[200px]" title="${item.folderName}">${item.folderName}</td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-white">${item.parsedMainName}</div>
                                <div class="text-xs text-gray-500">${item.parsedAliases.join(', ')}</div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-xs font-bold border border-blue-500/30">${item.mediaCount}</span>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function toggleAll(source) {
                document.querySelectorAll('.item-check').forEach(cb => cb.checked = source.checked);
            }

            // --- HÀM KẾT NỐI SSE (ĐÃ SỬA LỖI TREO) ---
            function connectProgress() {
                return new Promise((resolve, reject) => {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                    }

                    console.log("Connecting to SSE...");
                    eventSource = new EventSource('/admin/scan-subjects/progress');

                    const timeout = setTimeout(() => {
                        if (eventSource.readyState !== EventSource.OPEN) {
                            console.warn("SSE Connection timed out (5s).");
                            eventSource.close();
                            resolve();
                        }
                    }, 5000);

                    eventSource.onopen = function (e) {
                        clearTimeout(timeout);
                        console.log("SSE Connected successfully (onopen).");
                        resolve();
                    };

                    // 1. Lắng nghe sự kiện INIT (để debug)
                    eventSource.addEventListener('init', function (e) {
                        console.log("SSE Init received:", e.data);
                    });

                    // 2. QUAN TRỌNG: SỬA TỪ 'onmessage' THÀNH 'addEventListener' CHO SỰ KIỆN 'progress'
                    eventSource.addEventListener('progress', function (event) {
                        const data = JSON.parse(event.data);
                        updateProgressUI(data);

                        // THÊM ĐOẠN NÀY: Tự động ngắt kết nối khi hoàn thành
                        if (data.status === 'COMPLETED') {
                            console.log("All folders imported. Closing SSE.");
                            eventSource.close();

                            // Đợi 1 chút cho thanh progress đầy 100% rồi mới đóng
                            setTimeout(() => {
                                document.getElementById('progressModal').close();
                                alert("All selected folders have been imported successfully!");
                                window.location.href = "/subjects";
                            }, 500);
                        }
                    });

                    // (Optional) Giữ lại onmessage để bắt các lỗi chung nếu server gửi text thuần
                    eventSource.onmessage = function (event) {
                        console.log("Received unnamed message:", event.data);
                    };

                    eventSource.onerror = function (err) {
                        clearTimeout(timeout);
                        if (eventSource.readyState !== EventSource.CONNECTING) {
                            // console.error("SSE Error:", err); // Tắt bớt log đỏ nếu muốn
                        }
                        eventSource.close();
                        resolve();
                    };
                });
            }

            function updateProgressUI(data) {
                document.getElementById('progSubject').innerText = data.subject || '...';
                document.getElementById('progFile').innerText = data.fileName || '...';
                document.getElementById('progStatus').innerText = data.status || 'Processing';
                document.getElementById('progCount').innerText = `${data.currentFileIndex} / ${data.totalFiles}`;

                // Fix lỗi hiển thị khi chưa có file nào (0 chia 0)
                let percent = Math.floor(data.currentFileIndex / data.totalFiles);
                if (data.totalFiles === 0 || isNaN(percent)) {
                    percent = 0;
                }

                document.getElementById('progBar').style.width = `${percent}%`;
                document.getElementById('progPercent').innerText = `${percent}%`;
            }

            // --- EXECUTE IMPORT (ĐÃ SỬA LỖI STREAM READ) ---
            async function executeImport() {
                const selectedIndices = Array.from(document.querySelectorAll('.item-check:checked')).map(cb => cb.value);
                if (selectedIndices.length === 0)
                    return alert("Select at least one folder!");

                await document.getElementById('checkingModal').showModal();

                currentPathsToImport = selectedIndices.map(i => scanResults[i].fullPath);

                // 1. Kết nối SSE trước để lắng nghe tiến trình (cho cả check duplicate lẫn import)
                try {
                    // 2. Hiện Modal Checking
                    await connectProgress();
                } catch (e) {
                    alert("Error connect to SSE!");
                    console.warn("SSE Connect Warning:", e);
                }

                try {
                    console.log("Sending check-duplicates request...");

                    const res = await fetch('/admin/scan-subjects/check-duplicates', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', [getHeader()]: getToken()},
                        body: JSON.stringify(currentPathsToImport)
                    });

                    // Đọc response
                    const responseText = await res.text();

                    // 3. Ẩn Modal Checking ngay khi có kết quả
                    document.getElementById('checkingModal').close();

                    if (!res.ok)
                        throw new Error(`Server Error: ${responseText}`);

                    try {
                        duplicateGroups = JSON.parse(responseText);
                    } catch (e) {
                        duplicateGroups = []; // Nếu rỗng hoặc lỗi parse
                    }

                    if (duplicateGroups && duplicateGroups.length > 0) {
                        // Có trùng -> Hiện bảng giải quyết
                        renderDuplicateModal(duplicateGroups);
                        document.getElementById('duplicateModal').showModal();
                    } else {
                        runImportProcess({safePaths: currentPathsToImport, actions: []});
                    }

                } catch (e) {
                    document.getElementById('checkingModal').close(); // Đảm bảo đóng nếu lỗi
                    console.error("Execute Import Error:", e);
                    alert("Failed: " + e.message);
                    if (eventSource)
                        eventSource.close();
                }
            }

            async function runImportProcess(payload) {
                document.getElementById('progressModal').showModal(); // Hiện thanh tiến trình

                // Reset UI tiến trình
                updateProgressUI({
                    subject: 'Initializing...',
                    fileName: 'Starting background job...',
                    status: 'Starting',
                    filePercent: 0, currentFileIndex: 0, totalFiles: 0
                });

                try {
                    const res = await fetch('/admin/scan-subjects/execute-resolved', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json', [getHeader()]: getToken()},
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        console.log("Job started in background.");
                        // --- QUAN TRỌNG: ĐÃ XÓA eventSource.close() Ở ĐÂY ---
                        // Để kết nối mở cho SSE cập nhật tiếp
                    } else {
                        alert("Failed to start import job.");
                        document.getElementById('progressModal').close();
                        if (eventSource)
                            eventSource.close();
                    }
                } catch (e) {
                    console.error(e);
                    document.getElementById('progressModal').close();
                    if (eventSource)
                        eventSource.close();
                    alert("Error calling API");
                }
            }


            // --- RENDER & CONFIRM DUPLICATE (Giữ nguyên logic HTML string) ---
            function renderDuplicateModal(groups) {
                const container = document.getElementById('duplicateContent');
                container.innerHTML = '';
                groups.forEach((group, gIndex) => {
                    const groupHtml = `
                        <div class="bg-[#2e2839] rounded-xl border border-white/5 overflow-hidden">
                            <div class="px-4 py-2 bg-primary/20 border-b border-white/5 font-bold text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined text-sm">folder</span> ${group.subjectName}
                            </div>
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-gray-500 uppercase bg-[#1e1926]">
                                    <tr>
                                        <th class="px-4 py-3 w-[40%]">Existing File</th>
                                        <th class="px-4 py-3 w-[20%] text-center">Action</th>
                                        <th class="px-4 py-3 w-[40%]">New File</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-white/5">
                                    ${group.pairs.map((pair, pIndex) => `
                                        <tr>
                                            <td class="px-4 py-4 align-top">
                                                <div class="text-white font-medium break-all">${pair.existingFileName}</div>
                                                <div class="text-xs text-gray-500 font-mono mt-1">${pair.existingPath}</div>
                                                <div class="text-xs text-gray-400 mt-1">Size: ${pair.existingSize}</div>
                                            </td>
                                            <td class="px-4 py-4 align-top">
                                                <div class="flex flex-col gap-2">
                                                    <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors border border-transparent has-[:checked]:border-red-500/50 has-[:checked]:bg-red-500/10">
                                                        <input type="radio" name="action_${gIndex}_${pIndex}" value="KEEP_OLD" class="text-red-500 focus:ring-0" checked>
                                                        <div><div class="font-bold text-red-400 text-xs">Keep Old</div></div>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors border border-transparent has-[:checked]:border-green-500/50 has-[:checked]:bg-green-500/10">
                                                        <input type="radio" name="action_${gIndex}_${pIndex}" value="KEEP_NEW" class="text-green-500 focus:ring-0">
                                                        <div><div class="font-bold text-green-400 text-xs">Keep New</div></div>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-white/5 transition-colors border border-transparent has-[:checked]:border-blue-500/50 has-[:checked]:bg-blue-500/10">
                                                        <input type="radio" name="action_${gIndex}_${pIndex}" value="KEEP_BOTH" class="text-blue-500 focus:ring-0">
                                                        <div><div class="font-bold text-blue-400 text-xs">Keep Both</div></div>
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="px-4 py-4 align-top">
                                                <div class="text-white font-medium break-all">${pair.newFileName}</div>
                                                <div class="text-xs text-green-500 font-mono mt-1">New Location</div>
                                                <div class="text-xs text-gray-400 mt-1">Size: ${pair.newSize}</div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    container.innerHTML += groupHtml;
                });
            }

            async function confirmResolvedImport() {
                const actions = [];
                duplicateGroups.forEach((group, gIndex) => {
                    group.pairs.forEach((pair, pIndex) => {
                        const selected = document.querySelector(`input[name="action_${gIndex}_${pIndex}"]:checked`).value;
                        actions.push({
                            action: selected,
                            existingFileId: pair.existingFileId,
                            newFilePath: pair.newFilePath
                        });
                    });
                });

                document.getElementById('duplicateModal').close();

                // Gọi hàm runImportProcess tách riêng
                await runImportProcess({
                    safePaths: currentPathsToImport,
                    actions: actions
                });
            }

            function getToken() {
                return document.querySelector('meta[name="_csrf"]').getAttribute('content');
            }
            function getHeader() {
                return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            }

            window.addEventListener('beforeunload', () => {
                if (eventSource) {
                    eventSource.close();
                }
            });
        </script>
    </body>
</html>